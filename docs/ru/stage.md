# Класс Stage

Класс `Stage` соответствует отдельной сцене или уровню в игре. Он управляет спрайтами, фонами, звуками и игровыми циклами. 

**Важно:** перед созданием объекта `Stage` необходимо создать экземпляр класса `Game`, иначе будет вызвана ошибка.

## Конструктор:

```javascript
new Stage();
```

Создаёт новую сцену.

---

## Основные свойства:

| Свойство         | Тип                      | Описание                                              |
|------------------|--------------------------|-------------------------------------------------------|
| `width`          | `number`, только чтение  | Ширина сцены (холста)                                 |
| `height`         | `number`, только чтение  | Высота сцены (холста)                                 |
| `running`        | `boolean`, только чтение | Указывает, запущена ли сцена                          |
| `isReady`        | `boolean`, только чтение | Указывает, загружены ли все ресурсы сцены и спрайтов  |
| `backgroundColor`| `string`                 | Цвет фона сцены (например, `#00FF00` или `lightblue`) |

---

## Содержание
*   [События](#события)
*   [Состояния](#состояния)
*   [Фоны](#фоны)
*   [Звуки](#звуки)
*   [Управление спрайтами](#управление-спрайтами)
*   [Рисование и штампы](#рисование-и-штампы)
*   [Циклы и планировщики](#циклы-и-планировщики)
*   [Примеры использования](#примеры-использования)
*   [Общие рекомендации](#общие-рекомендации)

## События

Этот раздел описывает методы для управления событиями, связанными со сценой.

### Метод onStart()

```javascript
onStart(onStartCallback: CallableFunction): void
```

Регистрирует функцию обратного вызова, которая будет выполнена при запуске сцены.

**Параметры:**

* `onStartCallback` (`CallableFunction`) - Функция, которая будет выполнена при запуске сцены.

**Описание:**

Добавляет функцию обратного вызова в список функций, которые будут вызваны при запуске сцены.

**Пример использования:**

```javascript
const stage = new Stage();
stage.onStart(() => {
    console.log('Сцена запущена!');
});
```

---

### Метод onReady()

```javascript
onReady(callback: CallableFunction): void
```

Регистрирует функцию обратного вызова, которая будет выполнена, когда сцена будет готова к использованию.

**Параметры:**

* `callback` (`CallableFunction`) - Функция, которая будет выполнена после подготовки сцены.

**Описание:**

Добавляет функцию обратного вызова в список функций, которые будут вызваны, когда сцена будет готова к использованию (т.е. когда загружены все необходимые ресурсы, такие как фоны и звуки).

**Пример использования:**

```javascript
const stage = new Stage();
stage.addBackground('images/background.jpg');

stage.onReady(() => {
    console.log('Сцена готова к использованию!');
});
```

## Состояния

Этот раздел описывает свойства, отражающие текущее состояние сцены.

### Свойство running

```javascript
get running(): boolean
```

Возвращает значение, показывающее, запущена ли сцена.

**Возвращаемое значение:**

* (`boolean`) - `true`, если сцена запущена, `false` - в противном случае.

**Описание:**

Показывает, находится ли сцена в состоянии выполнения.

**Пример использования:**

```javascript
const stage = new Stage();
console.log(`Сцена запущена: ${stage.running}`);
```

---

### свойство stopped

Возвращает значение, показывающее, остановлена ли сцена.

**Возвращаемое значение:**

* (`boolean`) - `true`, если сцена остановлена, `false` - в противном случае.

**Описание:**

Показывает, находится ли сцена в состоянии остановки.

**Пример использования:**

```javascript
const stage = new Stage();
console.log(`Сцена остановлена: ${stage.stopped}`);
```

---

### Метод isReady()

```javascript
isReady(): boolean
```

Возвращает значение, показывающее, готова ли сцена к использованию.

**Возвращаемое значение:**

* (`boolean`) - `true`, если сцена готова, `false` - в противном случае.

**Описание:**

Определяет, загружены ли все необходимые ресурсы (спрайты, фоны) и готова ли сцена к началу работы.

**Пример использования:**

```javascript
const stage = new Stage();
stage.addBackground('images/background.jpg');

stage.onReady(() => {
    console.log(`Сцена готова: ${stage.isReady()}`);
});
```

### Размеры

Этот раздел описывает свойства, определяющие размеры сцены.

### Свойство width

Возвращает ширину сцены.

**Возвращаемое значение:**

* (`number`) - ширина сцены в пикселях.

**Описание:**

Возвращает текущую ширину canvas, используемого сценой.

**Пример использования:**

```javascript
const stage = new Stage();
console.log(`Ширина сцены: ${stage.width}`);
```

---

### Свойство height

Возвращает высоту сцены.

**Возвращаемое значение:**

* (`number`) - высота сцены в пикселях.

**Описание:**

Возвращает текущую высоту canvas, используемого сценой.

**Пример использования:**

```javascript
const stage = new Stage();
console.log(`Высота сцены: ${stage.height}`);
```

## Фоны:

Этот раздел посвящен методам управления фоновыми изображениями сцены. Вы можете задавать цвет фона, рисовать фон с помощью canvas API, добавлять изображения в качестве фона и переключаться между ними.

### Свойство backgroundColor

Устанавливает цвет фона сцены.

**Параметры:**

*   `color` (*string*) - цвет фона в формате CSS (например, `'red'`, `'#FF0000'`, `'rgb(255, 0, 0)'`).

**Описание:**

Создает фон сцены с указанным цветом.

**Пример использования:**

```javascript
const stage = new Stage();
stage.backgroundColor = 'blue'; // Создать фон синего цвета
```

---

### Метод drawBackground()

```javascript
drawBackground(callback: DrawingCallbackFunction): this
```

Рисует фон сцены с использованием canvas API.

**Параметры:**

*   `callback` (*DrawingCallbackFunction*) - функция рисования, которая принимает контекст canvas и объект сцены.

**Возвращаемое значение:**

*   (`this`) - возвращает текущую сцену.

**Описание:**

Создает фон сцены, используя функцию обратного вызова для выполнения пользовательских операций рисования.

**Пример использования:**

```javascript
const stage = new Stage();
stage.drawBackground((context, stage) => {
    context.fillStyle = 'green';
    context.fillRect(0, 0, stage.width, stage.height);
}); // Рисует зеленый фон
```

---

### Метод addBackground()

```javascript
addBackground(backgroundPath: string): this
```

Добавляет изображение в качестве фона сцены.

**Параметры:**

*   `backgroundPath` (*string*) - путь к изображению фона.

**Возвращаемое значение:**

*   (`this`) - возвращает текущую сцену.

**Описание:**

Загружает изображение и добавляет его в список доступных фонов сцены. Если загрузка изображения завершилась ошибкой, генерируется ошибка.

**Пример использования:**

```javascript
const stage = new Stage();
stage.addBackground('images/background.jpg'); // Добавить изображение как фон
```

---

### Метод switchBackground()

```javascript
switchBackground(backgroundIndex: number): void
```

Переключает текущий фон на указанный индекс.

**Параметры:**

*   `backgroundIndex` (*number*) - индекс фона в списке доступных фонов.

**Описание:**

Устанавливает текущий фон сцены на фон с указанным индексом. Если фон с таким индексом не найден, ничего не происходит.

**Пример использования:**

```javascript
const stage = new Stage();
stage.addBackground('images/background1.jpg');
stage.addBackground('images/background2.jpg');

stage.switchBackground(1); // Переключиться на второй фон
```

---

### Метод nextBackground()

```javascript
nextBackground(): void
```

Переключает текущий фон на следующий в списке доступных фонов.

**Описание:**

Устанавливает следующий фон из списка доступных. Если достигнут конец списка, переключается на первый фон.

**Пример использования:**

```javascript
const stage = new Stage();
stage.addBackground('images/background1.jpg');
stage.addBackground('images/background2.jpg');

stage.nextBackground(); // Переключиться на следующий фон
```

## Звуки

Этот раздел описывает методы для управления звуковыми файлами сцены. Вы можете добавлять, удалять, воспроизводить и приостанавливать звуки.

### Метод addSound()

```javascript
addSound(soundPath: string, name: string = null): this
```

Добавляет звуковой файл к сцене.

**Параметры:**

*   `soundPath` (`string`) - путь к звуковому файлу
*   `name` (`string`, необязательно) - имя звука. Если не указано, генерируется автоматически

**Возвращаемое значение:**

*   (`this`) - текущая сцена

**Описание:**

Загружает звуковой файл и добавляет его в список звуков сцены. Автоматически генерирует имя вида "No name", если имя не указано.

**Пример использования:**

```javascript
stage.addSound('sounds/explosion.mp3', 'explosion');
```

---

### Метод removeSound()

```javascript
removeSound(soundIndex: number = 0): this
```

Удаляет звук по индексу.

**Параметры:**

*   `soundIndex` (`number`, по умолчанию 0) - индекс звука для удаления

**Возвращаемое значение:**

*   (`this`) - текущая сцена

**Описание:**

Удаляет звук из списка по указанному индексу. Генерирует ошибку при неверном индексе.

**Пример использования:**

```javascript
stage.removeSound(1); // Удаляет второй звук
```

---

### Метод removeSoundByName()

```javascript
removeSoundByName(soundName: string): this
```

Удаляет звук по имени.

**Параметры:**

*   `soundName` (`string`) - имя звука для удаления

**Возвращаемое значение:**

*   (`this`) - текущая сцена

**Описание:**

Ищет звук по имени и удаляет его. Генерирует ошибку, если звук с указанным именем не найден.

**Пример использования:**

```javascript
stage.removeSoundByName('explosion');
```

---

### Метод playSound()

```javascript
playSound(soundIndex: number = 0, volume: number = null, currentTime: number = null): void
```

Воспроизводит звук по индексу.

**Параметры:**

*   `soundIndex` (`number`, по умолчанию 0) - индекс звука
*   `volume` (`number`, необязательно) - громкость (0-1)
*   `currentTime` (`number`, необязательно) - время начала воспроизведения (в секундах)

**Описание:**

Запускает воспроизведение указанного звука. Поддерживает установку громкости и позиции воспроизведения.

**Пример использования:**

```javascript
stage.playSound(0, 0.5, 2.5); // Воспроизводит первый звук с громкостью 50% начиная с 2.5 секунды
```

---

### Метод pauseSound()

```javascript
pauseSound(soundIndex: number = 0): void
```

Приостанавливает воспроизведение звука.

**Параметры:**

*   `soundIndex` (`number`, по умолчанию 0) - индекс звука

**Описание:**

Останавливает воспроизведение указанного звука. Генерирует ошибку при неверном индексе.

**Пример использования:**

```javascript
stage.pauseSound(0); // Пауза для первого звука
```

---

### Метод playSoundByName()

```javascript
playSoundByName(soundName: string, volume: number = null, currentTime: number = null): void
```

Воспроизводит звук по имени.

**Параметры:**

*   `soundName` (`string`) - имя звука
*   `volume` (`number`, необязательно) - громкость (0-1)
*   `currentTime` (`number`, необязательно) - время начала воспроизведения (в секундах)

**Описание:**

Ищет звук по имени и запускает его воспроизведение. Генерирует ошибку, если звук не найден.

**Пример использования:**

```javascript
stage.playSoundByName('explosion', 0.8);
```

---

### Метод pauseSoundByName()

```javascript
pauseSoundByName(soundName: string): void
```

Приостанавливает звук по имени.

**Параметры:**

*   `soundName` (`string`) - имя звука

**Описание:**

Ищет звук по имени и останавливает его воспроизведение. Генерирует ошибку, если звук не найден.

**Пример использования:**

```javascript
stage.pauseSoundByName('background_music');
```

## Управление спрайтами

Этот раздел описывает методы для управления спрайтами на сцене. 

### Метод addSprite()

```javascript
addSprite(sprite: Sprite): this
```

Добавляет спрайт на сцену. **Этот метод вызывается автоматически при создании спрайта через `new Sprite(stage)` и не требует ручного вызова.**

**Параметры:**

* `sprite` (`Sprite`) - спрайт для добавления.

**Возвращаемое значение:**

* (`this`) - возвращает текущую сцену.

**Описание:**

Добавляет указанный спрайт на соответствующий слой сцены. Вручную вызывать этот метод не нужно, так как он вызывается автоматически при создании спрайта.

**Пример использования:**

```javascript
// Спрайт автоматически добавляется на сцену
const sprite = new Sprite(stage);
```

---

### Метод removeSprite()

```javascript
removeSprite(sprite: Sprite, layer: number): this
```

Удаляет спрайт с указанного слоя сцены.

**Параметры:**

* `sprite` (`Sprite`) - спрайт для удаления.
* `layer` (`number`) - номер слоя, с которого нужно удалить спрайт.

**Возвращаемое значение:**

* (`this`) - возвращает текущую сцену.

**Описание:**

Удаляет указанный спрайт с заданного слоя. Если слой становится пустым после удаления, он также удаляется. Метод обновляет счетчики загруженных и добавленных спрайтов.

**Пример использования:**

```javascript
const sprite = new Sprite(stage);
stage.removeSprite(sprite, sprite.layer);
```

---

### Метод getSprites()

```javascript
getSprites(): Sprite[]
```

Возвращает массив всех спрайтов на сцене.

**Возвращаемое значение:**

* (`Sprite[]`) - массив всех спрайтов на сцене.

**Описание:**

Собирает все спрайты со всех слоев сцены в один массив и возвращает его.

**Пример использования:**

```javascript
const allSprites = stage.getSprites();
console.log(`Всего спрайтов на сцене: ${allSprites.length}`);
```

## Рисование и штампы

Этот раздел описывает методы, которые позволяют создавать штампы и визуальные эффекты на сцене.

### Метод stampImage()

```javascript
stampImage(stampImage: HTMLCanvasElement | HTMLImageElement, x: number, y: number, direction = 0): void
```

Создает отпечаток изображения на фоне сцены.

**Параметры:**

*   `stampImage` (`HTMLCanvasElement | HTMLImageElement`) - изображение для отпечатка.
*   `x` (`number`) - координата X центра отпечатка.
*   `y` (`number`) - координата Y центра отпечатка.
*   `direction` (`number`, необязательно, по умолчанию `0`) - угол поворота отпечатка в градусах.

**Описание:**

Создает статический отпечаток указанного изображения на фоне сцены.

**Пример использования:**

```javascript
const image = new Image();
image.src = 'images/player.png';

image.addEventListener('load', () => {
    stage.stampImage(image, 100, 100, 45); // Создать отпечаток изображения на сцене
});
```

---

### Метод pen()

```javascript
pen(callback: DrawingCallbackFunction, layer = 0): void
```

Добавляет функцию рисования для указанного слоя сцены.

**Параметры:**

*   `callback` (`DrawingCallbackFunction`) - функция, которая будет рисовать на canvas.
*   `layer` (`number`, необязательно, по умолчанию `0`) - слой, на котором будет производиться рисование.

**Описание:**

Позволяет добавлять пользовательские рисунки на указанный слой сцены. Функция `callback` вызывается для каждого кадра, позволяя создавать динамические визуальные эффекты.

**Пример использования:**

```javascript
stage.pen((context, stage) => {
    context.fillStyle = 'red';
    context.fillRect(0, 0, 50, 50);
});

// Динамическое рисование
stage.pen((context, stage) => {
    context.fillStyle = 'blue';
    context.beginPath();
    context.arc(25, 25, 20, 0, 2 * Math.PI);
    context.fill();
});
```

## Циклы и планировщики:

Этот раздел описывает методы для планирования выполнения функций с задержкой или с определенным интервалом, что позволяет создавать анимации, таймеры и другие динамические эффекты на сцене.

---

### Метод timeout()

```javascript
timeout(callback: ScheduledCallbackFunction, timeout: number): void
```

Выполняет функцию один раз после указанной задержки на сцене.

**Параметры:**

* `callback` (`ScheduledCallbackFunction`) - функция для выполнения.
* `timeout` (`number`) - задержка перед выполнением (в миллисекундах).

**Описание:**

Планирует выполнение функции после указанной задержки. Это эквивалентно использованию `repeat` с `repeat: 1`. Функция будет выполнена в контексте сцены.

**Пример использования:**

```javascript
stage.timeout(() => {
    console.log('Выполнилось после задержки на сцене!');
}, 2000); // Выполнится через 2 секунды
```

---

### Метод repeat()

```javascript
repeat(callback: ScheduledCallbackFunction, repeat: number, interval: number = null, timeout: number = null, finishCallback?: ScheduledCallbackFunction): ScheduledState
```

Выполняет функцию указанное количество раз с заданным интервалом на сцене.

**Параметры:**

* `callback` (`ScheduledCallbackFunction`) - Функция для выполнения.
* `repeat` (`number`) - Количество повторений.
* `interval` (`number`, необязательно, по умолчанию `null`) - Интервал между выполнениями (в миллисекундах). Если не указано, функция будет выполняться максимально быстро.
* `timeout` (`number`, необязательно, по умолчанию `null`) - Максимальное время выполнения (в миллисекундах). Если указано, выполнение будет остановлено по истечении этого времени.
* `finishCallback` (`ScheduledCallbackFunction`, необязательно) - Функция, которая будет вызвана после завершения всех повторений.

**Возвращаемое значение:**

* (`ScheduledState`) - Объект состояния, содержащий информацию о планировании.

**Описание:**

Планирует выполнение функции `repeat` раз с интервалом `interval`. Можно указать `timeout` для ограничения времени выполнения и `finishCallback` для вызова по завершении. Функция будет выполнена в контексте сцены.

**Пример использования:**

```javascript
stage.repeat((stage, state) => {
    console.log('Выполнилось ' + state.currentIteration + ' раз на сцене');
}, 5, 1000); // Выполнится 5 раз с интервалом 1 секунда
```

---

### Метод forever()

```javascript
forever(callback: ScheduledCallbackFunction, interval: number = null, timeout: number = null, finishCallback?: ScheduledCallbackFunction): ScheduledState
```

Выполняет функцию бесконечно с заданным интервалом на сцене.

**Параметры:**

* `callback` (`ScheduledCallbackFunction`) - Функция для выполнения.
* `interval` (`number`, необязательно, по умолчанию `null`) - Интервал между выполнениями (в миллисекундах). Если не указано, функция будет выполняться максимально быстро.
* `timeout` (`number`, необязательно, по умолчанию `null`) - Максимальное время выполнения (в миллисекундах). Если указано, выполнение будет остановлено по истечении этого времени.
* `finishCallback` (`ScheduledCallbackFunction`, необязательно) - Функция, которая будет вызвана после остановки выполнения.

**Возвращаемое значение:**

* (`ScheduledState`) - Объект состояния, содержащий информацию о планировании.

**Описание:**

Планирует выполнение функции бесконечно с интервалом `interval`. Можно указать `timeout` для ограничения времени выполнения и `finishCallback` для вызова по остановке. Функция будет выполнена в контексте сцены.

**Пример использования:**

```javascript
stage.forever(() => {
    console.log('Выполняется постоянно на сцене!');
}, 500); // Выполняется каждые полсекунды
```

## Примеры использования

### Создание сцены:

```javascript
const game = new Game();
const stage = new Stage();
stage.backgroundColor = 'lightblue';
```

### Управление фоном:

```javascript
stage.addBackground("path/to/bg.jpg");      // Добавить фоновое изображение
stage.switchBackground(0);                  // Переключить фон по индексу
stage.nextBackground();                     // Перейти к следующему фону
```

### Рисование фона:

```javascript
stage.drawBackground((context, stage) => {
    // Рисуем небо
    context.fillStyle = 'lightblue';
    context.fillRect(0, 0, stage.width, stage.height);
    
    // Рисуем солнце
    context.fillStyle = 'yellow';
    context.beginPath();
    context.arc(stage.width / 2, 100, 50, 0, Math.PI * 2);
    context.fill();

    // Рисуем горы
    context.fillStyle = 'gray';
    context.beginPath();
    context.moveTo(0, stage.height);
    context.lineTo(stage.width / 2, stage.height - 200);
    context.lineTo(stage.width, stage.height);
    context.fill();

    // Рисуем деревья
    context.fillStyle = 'green';
    context.fillRect(100, stage.height - 150, 50, 100);
    context.fillRect(300, stage.height - 120, 50, 100);
    context.fillRect(500, stage.height - 150, 50, 100);

    // Рисуем траву
    context.fillStyle = 'lightgreen';
    context.fillRect(0, stage.height - 50, stage.width, 50);
});
```

### Звуки:

```javascript
stage.addSound("audio.mp3", "music");       // Добавить звуковой файл
stage.playSoundByName("music");             // Воспроизвести звук
stage.pauseSoundByName("music");            // Приостановить воспроизведение
stage.removeSoundByName("music");           // Удалить звук
```

### Штамп:

```javascript
const image = new Image();
image.src = 'stamp.png';
stage.stampImage(image, 100, 50, 90);   // Нанести изображение на фон
```

### События:

```javascript
stage.onReady(() => {
    console.log("Сцена готова");
});

stage.onStart(() => {
    console.log("Сцена запущена");
});
```

## Общие рекомендации

Когда нужно гарантировать, что все ресурсы и объекты будут загружены и инициализированы используйте метод `onReady`.
