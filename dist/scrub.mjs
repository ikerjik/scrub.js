var ot=class{constructor(t,e,i=0){this.connectActions=[g.JOINED,g.RECEIVE_DATA,g.MEMBER_JOINED,g.MEMBER_LEFT,g.GAME_STARTED,g.GAME_STOPPED,g.ERROR];this.socket=t,this.lobbyId=i,this.memberId=null,this.connects={},this._listenSocket()}_listenSocket(){this.socket.onmessage=t=>{let[e,i,s]=this._parse(t.data);e===g.RECEIVE_DATA?this.emit(g.RECEIVE_DATA,[s,i,i?.MemberId===this.memberId]):e===g.MEMBER_JOINED?this.emit(g.MEMBER_JOINED,[i,i?.MemberId===this.memberId]):e===g.MEMBER_LEFT?this.emit(g.MEMBER_LEFT,[i,i?.MemberId===this.memberId]):this.connects[e]&&this.emit(e,[i])}}emit(t,e){this.connects[t]&&this.connects[t].forEach(i=>{i(...e)})}connect(t,e){if(!this.connectActions.includes(t))throw new Error("This actions is not defined.");return this.connects[t]||(this.connects[t]=[]),this.connects[t].push(e),e}disconnect(t,e){if(!this.connectActions.includes(t))throw new Error("This action is not defined.");this.connects[t]&&(this.connects[t]=this.connects[t].filter(i=>i!==e))}sendData(t,e={}){if(!this.lobbyId)throw new Error("You are not in the lobby!");let i=`${g.SEND_DATA}
`;for(let[s,r]of Object.entries(e))i+=s+"="+r+`
`;i+=`SendTime=${Date.now()}
`,i+=`
`+t,this.socket.send(i)}joinLobby(t,e,i={}){return new Promise((s,r)=>{e||(e=0);let o=`${g.JOIN_LOBBY}
`;o+=`GameToken=${t}
`,o+=`LobbyId=${e}
`;for(let[n,a]of Object.entries(i))o+=`${n}=${a}
`;this.socket.send(o),this.connect(g.JOINED,n=>{if(n.LobbyId&&n.MemberId&&n.CurrentTime){this.lobbyId=n.LobbyId,this.memberId=n.MemberId;let a=Date.now();this.deltaTime=a-Number(n.CurrentTime),s(this.lobbyId)}else r(new Error("Couldn't join the lobby"))})})}leaveLobby(){if(!this.lobbyId)return;let t=`${g.LEAVE_LOBBY}
LobbyId=${this.lobbyId}
`;this.socket.send(t),this.lobbyId=null}_parse(t){let e=t.split(`
`),i=e[0],s="",r=[],o="parameters";for(let n=1;n<e.length;n++){let a=e[n];if(a===""&&o==="parameters")o="value";else if(o==="parameters"){let l=a.split("="),h=l[0];r[h]=l.length>1?l[1]:null}else o==="value"&&(s=s+a+`
`)}return s&&(s=s.slice(0,-1)),[i,r,s]}};var g=class{constructor(t="ws://localhost:17500"){this.socketUrl=t,this.socket=null,this.defaultParameters={LobbyAutoCreate:!0,MaxMembers:2,MinMembers:2,StartGameWithMembers:2}}connect(t,e=null,i={}){let s={...this.defaultParameters,...i};return new Promise((r,o)=>{this.socket=new WebSocket(this.socketUrl),this.socket.onopen=()=>{let n=new ot(this.socket,t,e);n.joinLobby(t,e,s).then(()=>{r(n)}).catch(o)},this.socket.onerror=n=>{o(n)}})}};g.JOIN_LOBBY="JOIN_LOBBY",g.LEAVE_LOBBY="LEAVE_LOBBY",g.SEND_DATA="SEND_DATA",g.JOINED="JOINED",g.RECEIVE_DATA="RECEIVE_DATA",g.MEMBER_JOINED="MEMBER_JOINED",g.MEMBER_LEFT="MEMBER_LEFT",g.GAME_STARTED="GAME_STARTED",g.GAME_STOPPED="GAME_STOPPED",g.ERROR="ERROR";var Ct=[],it=class d{constructor(){this._bvh_parent=null;this._bvh_branch=!0;this._bvh_left=null;this._bvh_right=null;this._bvh_sort=0;this._bvh_min_x=0;this._bvh_min_y=0;this._bvh_max_x=0;this._bvh_max_y=0}static getBranch(){return Ct.length?Ct.pop():new d}static releaseBranch(t){Ct.push(t)}static sortBranches(t,e){return t.sort>e.sort?-1:1}};var V=class V{constructor(){this._hierarchy=null;this._bodies=[];this._dirty_branches=[]}insert(t,e=!1){if(!e){let p=t._bvh;if(p&&p!==this)throw new Error("Body belongs to another collision system");t._bvh=this,this._bodies.push(t)}let i=t._polygon,s=t.x,r=t.y;i&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords();let o=t._bvh_padding,n=i?0:t.radius*t.scale,a=(i?t._min_x:s-n)-o,l=(i?t._min_y:r-n)-o,h=(i?t._max_x:s+n)+o,u=(i?t._max_y:r+n)+o;t._bvh_min_x=a,t._bvh_min_y=l,t._bvh_max_x=h,t._bvh_max_y=u;let c=this._hierarchy,m=0;if(!c)this._hierarchy=t;else{let p=0;for(;p++<V.MAX_DEPTH;)if(c._bvh_branch){let _=c._bvh_left,f=_._bvh_min_y,b=_._bvh_max_x,v=_._bvh_max_y,C=a<_._bvh_min_x?a:_._bvh_min_x,S=l<f?l:f,E=h>b?h:b,I=u>v?u:v,U=(b-_._bvh_min_x)*(v-f),tt=(E-C)*(I-S)-U,N=c._bvh_right,A=N._bvh_min_x,z=N._bvh_min_y,j=N._bvh_max_x,T=N._bvh_max_y,R=a<A?a:A,O=l<z?l:z,F=h>j?h:j,$=u>T?u:T,et=(j-A)*(T-z),rt=(F-R)*($-O)-et;c._bvh_sort=m++,c._bvh_min_x=C<R?C:R,c._bvh_min_y=S<O?S:O,c._bvh_max_x=E>F?E:F,c._bvh_max_y=I>$?I:$,c=tt<=rt?_:N}else{let _=c._bvh_parent,f=c._bvh_min_x,b=c._bvh_min_y,v=c._bvh_max_x,C=c._bvh_max_y,S=c._bvh_parent=t._bvh_parent=it.getBranch();S._bvh_parent=_,S._bvh_left=c,S._bvh_right=t,S._bvh_sort=m++,S._bvh_min_x=a<f?a:f,S._bvh_min_y=l<b?l:b,S._bvh_max_x=h>v?h:v,S._bvh_max_y=u>C?u:C,_?_._bvh_left===c?_._bvh_left=S:_._bvh_right=S:this._hierarchy=S;break}}}remove(t,e=!1){if(!e){let n=t._bvh;if(n&&n!==this)throw new Error("Body belongs to another collision system");t._bvh=null,this._bodies.splice(this._bodies.indexOf(t),1)}if(this._hierarchy===t){this._hierarchy=null;return}let i=t._bvh_parent;if(!i){console.error("The parent is not defined in the collision system.");return}let s=i._bvh_parent,r=i._bvh_left,o=r===t?i._bvh_right:r;if(o._bvh_parent=s,o._bvh_branch&&(o._bvh_sort=i._bvh_sort),s){s._bvh_left===i?s._bvh_left=o:s._bvh_right=o;let n=s,a=0;for(;n&&a++<V.MAX_DEPTH;){let l=n._bvh_left,h=l._bvh_min_x,u=l._bvh_min_y,c=l._bvh_max_x,m=l._bvh_max_y,p=n._bvh_right,_=p._bvh_min_x,f=p._bvh_min_y,b=p._bvh_max_x,v=p._bvh_max_y;n._bvh_min_x=h<_?h:_,n._bvh_min_y=u<f?u:f,n._bvh_max_x=c>b?c:b,n._bvh_max_y=m>v?m:v,n=n._bvh_parent}}else this._hierarchy=o;it.releaseBranch(i)}update(){let t=this._bodies,e=t.length;for(let i=0;i<e;++i){let s=t[i],r=!1;if(!r&&s.padding!==s._bvh_padding&&(s._bvh_padding=s.padding,r=!0),!r){let o=s._polygon;o&&(s._dirty_coords||s.x!==s._x||s.y!==s._y||s.angle!==s._angle||s.scale_x!==s._scale_x||s.scale_y!==s._scale_y)&&s._calculateCoords();let n=s.x,a=s.y,l=o?0:s.radius*s.scale,h=o?s._min_x:n-l,u=o?s._min_y:a-l,c=o?s._max_x:n+l,m=o?s._max_y:a+l;r=h<s._bvh_min_x||u<s._bvh_min_y||c>s._bvh_max_x||m>s._bvh_max_y}r&&(this.remove(s,!0),this.insert(s,!0))}}potentials(t){let e=[],i=t._bvh_min_x,s=t._bvh_min_y,r=t._bvh_max_x,o=t._bvh_max_y,n=this._hierarchy,a=!0;if(!n||!n._bvh_branch)return e;let l=0;for(;n&&l++<V.MAX_DEPTH;){if(a){a=!1;let c=n._bvh_branch?n._bvh_left:null;for(;c&&c._bvh_max_x>=i&&c._bvh_max_y>=s&&c._bvh_min_x<=r&&c._bvh_min_y<=o;)n=c,c=n._bvh_branch?n._bvh_left:null}let h=n._bvh_branch,u=h?n._bvh_right:null;if(u&&u._bvh_max_x>i&&u._bvh_max_y>s&&u._bvh_min_x<r&&u._bvh_min_y<o)n=u,a=!0;else{!h&&n!==t&&e.push(n);let c=n._bvh_parent;if(c){for(;c&&c._bvh_right===n;)n=c,c=n._bvh_parent;n=c}else break}}return e}draw(t){let e=this._bodies,i=e.length;for(let s=0;s<i;++s)e[s].draw(t)}drawBVH(t){let e=this._hierarchy,i=!0;for(;e;){if(i){i=!1;let h=e._bvh_branch?e._bvh_left:null;for(;h;)e=h,h=e._bvh_branch?e._bvh_left:null}let s=e._bvh_branch,r=e._bvh_min_x,o=e._bvh_min_y,n=e._bvh_max_x,a=e._bvh_max_y,l=s?e._bvh_right:null;if(t.moveTo(r,o),t.lineTo(n,o),t.lineTo(n,a),t.lineTo(r,a),t.lineTo(r,o),l)e=l,i=!0;else{let h=e._bvh_parent;if(h){for(;h&&h._bvh_right===e;)e=h,h=e._bvh_parent;e=h}else break}}}};V.MAX_DEPTH=1e4;var at=V;function lt(d,t,e=null,i=!0){let s=d._polygon,r=t._polygon,o=!1;return e&&(e.a=d,e.b=t,e.a_in_b=!0,e.b_in_a=!0,e.overlap=null,e.overlap_x=0,e.overlap_y=0,e.collidedSprite=null),s&&(d._dirty_coords||d.x!==d._x||d.y!==d._y||d.angle!==d._angle||d.scale_x!==d._scale_x||d.scale_y!==d._scale_y)&&d._calculateCoords(),r&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords(),(!i||Rt(d,t))&&(s&&d._dirty_normals&&d._calculateNormals(),r&&t._dirty_normals&&t._calculateNormals(),o=s&&r?Mt(d,t,e):s?Et(d,t,e,!1):r?Et(t,d,e,!0):Dt(d,t,e)),e&&(e.collision=o),o}function Rt(d,t){let e=d._polygon,i=e?0:d.x,s=e?0:d.y,r=e?0:d.radius*d.scale,o=e?d._min_x:i-r,n=e?d._min_y:s-r,a=e?d._max_x:i+r,l=e?d._max_y:s+r,h=t._polygon,u=h?0:t.x,c=h?0:t.y,m=h?0:t.radius*t.scale,p=h?t._min_x:u-m,_=h?t._min_y:c-m,f=h?t._max_x:u+m,b=h?t._max_y:c+m;return o<f&&n<b&&a>p&&l>_}function Mt(d,t,e=null){let i=d._coords.length,s=t._coords.length;if(i===2&&s===2){let l=d._coords,h=t._coords;return e&&(e.overlap=0),l[0]===h[0]&&l[1]===h[1]}let r=d._coords,o=t._coords,n=d._normals,a=t._normals;if(i>2){for(let l=0,h=1;l<i;l+=2,h+=2)if(wt(r,o,n[l],n[h],e))return!1}if(s>2){for(let l=0,h=1;l<s;l+=2,h+=2)if(wt(r,o,a[l],a[h],e))return!1}return!0}function Et(d,t,e=null,i=!1){let s=d._coords,r=d._edges,o=d._normals,n=t.x,a=t.y,l=t.radius*t.scale,h=l*2,u=l*l,c=s.length,m=!0,p=!0,_=null,f=0,b=0;if(c===2){let v=n-s[0],C=a-s[1],S=v*v+C*C;if(S>u)return!1;if(e){let E=Math.sqrt(S);_=l-E,f=v/E,b=C/E,p=!1}}else for(let v=0,C=1;v<c;v+=2,C+=2){let S=n-s[v],E=a-s[C],I=r[v],U=r[C],J=S*I+E*U,tt=J<0?-1:J>I*I+U*U?1:0,N=!1,A=0,z=0,j=0;if(e&&m&&S*S+E*E>u&&(m=!1),tt){let T=tt===-1,R=T?v===0?c-2:v-2:v===c-2?0:v+2,O=R+1,F=n-s[R],$=a-s[O],et=r[R],nt=r[O],rt=F*et+$*nt;if((rt<0?-1:rt>et*et+nt*nt?1:0)===-tt){let yt=T?S:F,vt=T?E:$,xt=yt*yt+vt*vt;if(xt>u)return!1;if(e){let St=Math.sqrt(xt);N=!0,A=l-St,z=yt/St,j=vt/St,p=!1}}}else{let T=o[v],R=o[C],O=S*T+E*R,F=O<0?-O:O;if(O>0&&F>l)return!1;e&&(N=!0,A=l-O,z=T,j=R,(p&&O>=0||A<h)&&(p=!1))}N&&(_===null||_>A)&&(_=A,f=z,b=j)}return e&&(e.a_in_b=i?p:m,e.b_in_a=i?m:p,e.overlap=_,e.overlap_x=i?-f:f,e.overlap_y=i?-b:b),!0}function Dt(d,t,e=null){let i=d.radius*d.scale,s=t.radius*t.scale,r=t.x-d.x,o=t.y-d.y,n=i+s,a=r*r+o*o;if(a>n*n)return!1;if(e){let l=Math.sqrt(a);e.a_in_b=i<=s&&l<=s-i,e.b_in_a=s<=i&&l<=i-s,e.overlap=n-l,e.overlap_x=r/l,e.overlap_y=o/l}return!0}function wt(d,t,e,i,s=null){let r=d.length,o=t.length;if(!r||!o)return!0;let n=null,a=null,l=null,h=null;for(let u=0,c=1;u<r;u+=2,c+=2){let m=d[u]*e+d[c]*i;(n===null||n>m)&&(n=m),(a===null||a<m)&&(a=m)}for(let u=0,c=1;u<o;u+=2,c+=2){let m=t[u]*e+t[c]*i;(l===null||l>m)&&(l=m),(h===null||h<m)&&(h=m)}if(n>h||a<l)return!0;if(s){let u=0;if(n<l)if(s.a_in_b=!1,a<h)u=a-l,s.b_in_a=!1;else{let p=a-l,_=h-n;u=p<_?p:-_}else if(s.b_in_a=!1,a>h)u=n-h,s.a_in_b=!1;else{let p=a-l,_=h-n;u=p<_?p:-_}let c=s.overlap,m=u<0?-u:u;if(c===null||c>m){let p=u<0?-1:1;s.overlap=m,s.overlap_x=e*p,s.overlap_y=i*p}}return!1}var M=class{constructor(){this.collision=!1;this.a=null;this.b=null;this.a_in_b=!1;this.b_in_a=!1;this.overlap=0;this.overlap_x=0;this.overlap_y=0}};var q=class{constructor(t=0,e=0,i=5){this._offset_x=0;this._offset_y=0;this._circle=!1;this._polygon=!1;this._point=!1;this._bvh=null;this._bvh_parent=null;this._bvh_branch=!1;this._bvh_min_x=0;this._bvh_min_y=0;this._bvh_max_x=0;this._bvh_max_y=0;this._parent_sprite=null;this._center_distance=0;this._center_angle=0;this.x=t,this.y=e,this.padding=i,this._bvh_padding=i}collides(t,e=null,i=!0){return lt(this,t,e,i)}potentials(){let t=this._bvh;if(t===null)throw new Error("Body does not belong to a collision system");return t.potentials(this)}remove(){let t=this._bvh;t&&t.remove(this,!1)}set parentSprite(t){this._parent_sprite=t}get parentSprite(){return this._parent_sprite}set offset_x(t){this._offset_x=-t,this.updateCenterParams()}get offset_x(){return-this._offset_x}set offset_y(t){this._offset_y=-t,this.updateCenterParams()}get offset_y(){return-this._offset_y}get center_offset_x(){if(this._parent_sprite.rotateStyle==="leftRight"||this._parent_sprite.rotateStyle==="none"){let t=this._parent_sprite._direction>180&&this._parent_sprite.rotateStyle==="leftRight"?-1:1;return this._offset_x*t}return this._center_distance*Math.cos(this._center_angle-this._parent_sprite.globalAngleRadians)}get center_offset_y(){return this._parent_sprite.rotateStyle==="leftRight"||this._parent_sprite.rotateStyle==="none"?-this._offset_y:-this._center_distance*Math.sin(this._center_angle-this._parent_sprite.globalAngleRadians)}createResult(){return new M}updateCenterParams(){this._center_distance=Math.hypot(this._offset_x,this._offset_y),this._center_angle=-Math.atan2(-this._offset_y,-this._offset_x)}static createResult(){return new M}};var Y=class extends q{constructor(t=0,e=0,i=0,s=1,r=5){super(t,e,r),this.radius=i,this.scale=s}draw(t){let e=this.x,i=this.y,s=this.radius*this.scale;t.moveTo(e+s,i),t.arc(e,i,s,0,Math.PI*2)}};var w=class d extends q{constructor(e=0,i=0,s=[],r=0,o=1,n=1,a=5){super(e,i,a);this._min_x=0;this._min_y=0;this._max_x=0;this._max_y=0;this._points=null;this._coords=null;this._edges=null;this._normals=null;this._dirty_coords=!0;this._dirty_normals=!0;this._origin_points=null;this.angle=r,this.scale_x=o,this.scale_y=n,this._polygon=!0,this._x=e,this._y=i,this._angle=r,this._scale_x=o,this._scale_y=n,this._origin_points=s,d.prototype.setPoints.call(this,s)}draw(e){(this._dirty_coords||this.x!==this._x||this.y!==this._y||this.angle!==this._angle||this.scale_x!==this._scale_x||this.scale_y!==this._scale_y)&&this._calculateCoords();let i=this._coords;if(i.length===2)e.moveTo(i[0],i[1]),e.arc(i[0],i[1],1,0,Math.PI*2);else{e.moveTo(i[0],i[1]);for(let s=2;s<i.length;s+=2)e.lineTo(i[s],i[s+1]);i.length>4&&e.lineTo(i[0],i[1])}}setPoints(e){let i=e.length;this._points=new Float64Array(i*2),this._coords=new Float64Array(i*2),this._edges=new Float64Array(i*2),this._normals=new Float64Array(i*2);let s=this._points;for(let r=0,o=0,n=1;r<i;++r,o+=2,n+=2){let a=e[r];s[o]=a[0],s[n]=a[1]}this._dirty_coords=!0}_calculateCoords(){let e=this.x,i=this.y,s=this.angle,r=this.scale_x,o=this.scale_y,n=this._points,a=this._coords,l=n.length,h,u,c,m;for(let p=0,_=1;p<l;p+=2,_+=2){let f=n[p]*r,b=n[_]*o;if(s){let v=Math.cos(s),C=Math.sin(s),S=f,E=b;f=S*v-E*C,b=S*C+E*v}f+=e,b+=i,a[p]=f,a[_]=b,p===0?(h=u=f,c=m=b):(f<h?h=f:f>u&&(u=f),b<c?c=b:b>m&&(m=b))}this._x=e,this._y=i,this._angle=s,this._scale_x=r,this._scale_y=o,this._min_x=h,this._min_y=c,this._max_x=u,this._max_y=m,this._dirty_coords=!1,this._dirty_normals=!0}_calculateNormals(){let e=this._coords,i=this._edges,s=this._normals,r=e.length;for(let o=0,n=1;o<r;o+=2,n+=2){let a=o+2<r?o+2:0,l=e[a]-e[o],h=e[a+1]-e[n],u=l||h?Math.sqrt(l*l+h*h):0;i[o]=l,i[n]=h,s[o]=u?h/u:0,s[n]=u?-l/u:0}this._dirty_normals=!1}get points(){return this._origin_points}};var L=class extends w{constructor(t=0,e=0,i=5){super(t,e,[[0,0]],0,1,1,i),this._point=!0}};L.prototype.setPoints=void 0;var ht=class{constructor(){this._bvh=new at}createCircle(t=0,e=0,i=0,s=1,r=0){let o=new Y(t,e,i,s,r);return this._bvh.insert(o),o}createPolygon(t=0,e=0,i=[[0,0]],s=0,r=1,o=1,n=0){let a=new w(t,e,i,s,r,o,n);return this._bvh.insert(a),a}createPoint(t=0,e=0,i=0){let s=new L(t,e,i);return this._bvh.insert(s),s}createResult(){return new M}static createResult(){return new M}insert(...t){for(let e of t)this._bvh.insert(e,!1);return this}remove(...t){for(let e of t)this._bvh.remove(e,!1);return this}update(){return this._bvh.update(),this}draw(t){return this._bvh.draw(t)}drawBVH(t){return this._bvh.drawBVH(t)}potentials(t){return this._bvh.potentials(t)}collides(t,e,i=null,s=!0){return lt(t,e,i,s)}};var x=class x{static getMessage(t,e,i=null){if(!x.messages[t])throw new Error("Message is not defined.");if(!x.messages[t][e])throw new Error("Message for this locale is not defined.");let s=x.messages[t][e];return i&&(s=x.replaceVariables(s,i)),s}static replaceVariables(t,e){return t.replace(/\${([^}]+)}/g,(i,s)=>e[s]!==void 0?e[s]:"")}};x.SCRIPT_ERROR="script_error",x.MISTAKE_METHOD="mistake_method",x.MISTAKE_METHOD_WITH_CLOSEST="mistake_method_with_closest",x.NEED_STAGE_BEFORE_RUN_GAME="need_stage_before_run_game",x.NEED_CREATE_STAGE_BEFORE_SPRITE="need_create_stage_before_sprite",x.COSTUME_NOT_LOADED="costume_not_loaded",x.BACKGROUND_NOT_LOADED="background_not_loaded",x.CLONED_NOT_READY="cloned_not_ready",x.SOUND_INDEX_NOT_FOUND="sound_index_not_found",x.SOUND_NAME_NOT_FOUND="sound_name_not_found",x.SOUND_NAME_ALREADY_EXISTS="sound_name_already_exists",x.SOUND_NOT_ALLOWED_ERROR="sound_not_allowed_error",x.SOUND_USE_NOT_READY="sound_use_not_ready",x.COSTUME_INDEX_NOT_FOUND="costume_index_not_found",x.COSTUME_NAME_NOT_FOUND="costume_name_not_found",x.COSTUME_SWITCH_NOT_READY="costume_switch_not_ready",x.STAMP_NOT_READY="stamp_not_ready",x.STAMP_COSTUME_NOT_FOUND="stamp_costume_not_found",x.COLLIDER_NAME_NOT_FOUND="collider_name_not_found",x.messages={script_error:{ru:"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430, \u043E\u0437\u043D\u0430\u043A\u043E\u043C\u044C\u0442\u0435\u0441\u044C \u0441 \u043F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0439 \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0435\u0439 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.",en:"An error has occurred, take a look at the details in the console."},mistake_method:{ru:'${className}: \u041C\u0435\u0442\u043E\u0434 \u0438\u043B\u0438 \u0441\u0432\u043E\u0439\u0441\u0442\u0432\u043E "${prop}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E',en:'${className}: Method "${prop}" not found'},mistake_method_with_closest:{ru:'${className}: \u041C\u0435\u0442\u043E\u0434 \u0438\u043B\u0438 \u0441\u0432\u043E\u0439\u0441\u0442\u0432\u043E "${prop}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E. \u0412\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0432\u044B \u0438\u043C\u0435\u043B\u0438 \u0432\u0432\u0438\u0434\u0443: ${closestString}?',en:'${className}: Method "${prop}" not found. Did you mean: ${closestString}?'},need_stage_before_run_game:{ru:"\u0412\u0430\u043C \u043D\u0443\u0436\u043D\u043E \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u044D\u043A\u0437\u0435\u043C\u043F\u043B\u044F\u0440 Stage \u043F\u0435\u0440\u0435\u0434 \u0437\u0430\u043F\u0443\u0441\u043A\u043E\u043C \u0438\u0433\u0440\u044B.",en:"You need create Stage instance before run game."},need_create_stage_before_sprite:{ru:"\u0412\u0430\u043C \u043D\u0443\u0436\u043D\u043E \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u044D\u043A\u0437\u0435\u043C\u043F\u043B\u044F\u0440 \u043A\u043B\u0430\u0441\u0441\u0430 Stage \u043F\u0435\u0440\u0435\u0434 \u044D\u043A\u0437\u0435\u043C\u043F\u043B\u044F\u0440\u043E\u043C \u043A\u043B\u0430\u0441\u0441\u0430 Sprite.",en:"You need create Stage instance before Sprite instance."},costume_not_loaded:{ru:'\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u043A\u043E\u0441\u0442\u044E\u043C\u0430 "${costumePath}" \u043D\u0435 \u0431\u044B\u043B\u043E \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E\u0441\u0442\u044C \u043F\u0443\u0442\u0438.',en:'Costume image "${costumePath}" was not loaded. Check that the path is correct.'},background_not_loaded:{ru:'\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u0444\u043E\u043D\u0430 "${backgroundPath}" \u043D\u0435 \u0431\u044B\u043B\u043E \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E\u0441\u0442\u044C \u043F\u0443\u0442\u0438.',en:'Background image "${backgroundPath}" was not loaded. Check that the path is correct.'},cloned_not_ready:{ru:"\u0421\u043F\u0440\u0430\u0439\u0442 \u043D\u0435 \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u043A\u043B\u043E\u043D\u0438\u0440\u043E\u0432\u0430\u043D, \u043F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u043E\u043D \u0435\u0449\u0435 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043C\u0435\u0442\u043E\u0434 sprite.onReady()",en:"Sprite cannot be cloned because one is not ready. Try using the sprite.onReady() method."},sound_index_not_found:{ru:'\u0417\u0432\u0443\u043A \u0441 \u0438\u043D\u0434\u0435\u043A\u0441\u043E\u043C "${soundIndex}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.',en:'Sound with index "${soundIndex}" not found.'},sound_name_not_found:{ru:'\u0417\u0432\u0443\u043A \u0441 \u0438\u043C\u0435\u043D\u0435\u043C "${soundName}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.',en:'Sound with name "${soundName}" not found.'},sound_name_already_exists:{ru:'\u0417\u0432\u0443\u043A \u0441 \u0438\u043C\u0435\u043D\u0435\u043C "${soundName}" \u0443\u0436\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D.',en:'Sound with name "${soundName}" already exists.'},sound_use_not_ready:{ru:"\u0421\u043F\u0440\u0430\u0439\u0442 \u043D\u0435 \u043C\u043E\u0436\u0435\u0442 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0437\u0432\u0443\u043A\u0438, \u043F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0441\u043F\u0440\u0430\u0439\u0442 \u0435\u0449\u0435 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043C\u0435\u0442\u043E\u0434 sprite.onReady().",en:"Sprite cannot use sounds because sprite is not ready. Try using the sprite.onReady() method."},sound_not_allowed_error:{ru:"\u0412\u043E\u0441\u043F\u0440\u043E\u0438\u0437\u0432\u0435\u0434\u0435\u043D\u0438\u0435 \u0437\u0432\u0443\u043A\u0430 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043E. \u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0434\u043E\u043B\u0436\u0435\u043D \u0441\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u0437\u0430\u0438\u043C\u043E\u0434\u0435\u0439\u0441\u0442\u0432\u043E\u0432\u0430\u0442\u044C \u0441 \u0438\u0433\u0440\u043E\u0439. \u0412\u043E\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0439\u0442\u0435\u0441\u044C \u043C\u0435\u0442\u043E\u0434\u043E\u043C Game.onUserInteracted()",en:"Audio playback is blocked. The user must first interact with the game. Use the Game.onUserInteracted() method."},costume_index_not_found:{ru:'\u041A\u043E\u0441\u0442\u044E\u043C \u0441 \u0438\u043D\u0434\u0435\u043A\u0441\u043E\u043C "${costumeIndex}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.',en:'Costume with index "${costumeIndex}" not found.'},costume_name_not_found:{ru:'\u041A\u043E\u0441\u0442\u044E\u043C \u0441 \u0438\u043C\u0435\u043D\u0435\u043C "${costumeName}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.',en:'Costume with name "${costumeName}" not found.'},costume_switch_not_ready:{ru:"\u0421\u043F\u0440\u0430\u0439\u0442 \u043D\u0435 \u043C\u043E\u0436\u0435\u0442 \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u043A\u043E\u0441\u0442\u044E\u043C, \u043F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0441\u043F\u0440\u0430\u0439\u0442 \u0435\u0449\u0435 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043C\u0435\u0442\u043E\u0434 sprite.onReady().",en:"Sprite cannot change a costume because sprite is not ready. Try using the sprite.onReady() method."},stamp_not_ready:{ru:"\u0421\u043F\u0440\u0430\u0439\u0442 \u043D\u0435 \u043C\u043E\u0436\u0435\u0442 \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0448\u0442\u0430\u043C\u043F, \u043F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u043E\u043D \u0435\u0449\u0435 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043C\u0435\u0442\u043E\u0434 sprite.onReady()",en:"Sprite cannot create a stamp because sprite is not ready. Try using the sprite.onReady() method."},stamp_costume_not_found:{ru:'\u0428\u0442\u0430\u043C \u043D\u0435 \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u0441\u043E\u0437\u0434\u0430\u043D, \u0442\u0430\u043A \u043A\u0430\u043A \u043A\u043E\u0441\u0442\u044E\u043C \u0441 \u0438\u043D\u0434\u0435\u043A\u0441\u043E\u043C "${costumeIndex}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.',en:'The stamp cannot be created because the costume with the index "${costumeIndex}" has not been found.'},collider_name_not_found:{ru:'\u041A\u043E\u043B\u043B\u0430\u0439\u0434\u0435\u0440 \u0441 \u0438\u043C\u0435\u043D\u0435\u043C "${colliderName}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D.',en:'Collider with name "${colliderName}" not found.'}};var y=x;var ct=class ct{static getChar(t){return ct.map[t]}};ct.map=["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];var P=ct;var dt=class{constructor(){this.keys={};document.addEventListener("keydown",t=>{let e=P.getChar(t.keyCode);this.keys[e]=!0}),document.addEventListener("keyup",t=>{let e=P.getChar(t.keyCode);delete this.keys[e]})}keyPressed(t){return this.keys[t.toUpperCase()]!==void 0}keyDown(t,e){document.addEventListener("keydown",i=>{let s=P.getChar(i.keyCode);t.toUpperCase()==s&&e(i)})}keyUp(t,e){document.addEventListener("keyup",i=>{let s=P.getChar(i.keyCode);t.toUpperCase()==s&&e(i)})}};var ut=class{constructor(t){this.x=0;this.y=0;this.isDown=!1;document.addEventListener("mousedown",()=>{this.isDown=!0,this.lastStage=t.getActiveStage()}),document.addEventListener("mouseup",()=>{this.isDown=!1}),document.addEventListener("mousemove",e=>{this.x=t.correctMouseX(e.clientX),this.y=t.correctMouseY(e.clientY)}),this.point=new L(this.x,this.y)}getPoint(){return this.point.x=this.x,this.point.y=this.y,this.point}isMouseDown(t){return this.isDown&&t===this.lastStage}clearMouseDown(){this.isDown=!1}};var k=class d{constructor(){this.data={}}static getInstance(){return this.instance||(this.instance=new d),this.instance}set(t,e){this.data[t]=e}has(t){return this.data[t]!==void 0}get(t){return this.data[t]}};var st=class{constructor(t,e,i){this.canvas=t,this.setEnvironmentStyles(),this.setCanvasSize(e,i),this.canvasRect=t.getBoundingClientRect(),window.addEventListener("resize",()=>{this.setCanvasSize(e,i),this.canvasRect=t.getBoundingClientRect()})}setEnvironmentStyles(){document.body.style.margin="0",document.body.style.height="100vh",document.body.style.padding="0",document.body.style.overflow="hidden"}setCanvasSize(t,e){this.canvas.width=t||document.body.clientWidth,this.canvas.height=e||document.body.clientHeight}};var mt=class d{constructor(t){this.game=t}createValidator(t,e){let i=this.game;return new Proxy(t,{get(s,r){if(r in s)return s[r];if(typeof r=="symbol"||r.startsWith("_"))return;let o=Object.getOwnPropertyNames(Object.getPrototypeOf(s)).filter(a=>a!=="constructor"),n=d.findClosestMethods(r.toString(),o);if(n.length){let a=n.join(", ");i.throwError(y.MISTAKE_METHOD_WITH_CLOSEST,{className:e,prop:r,closestString:a})}else i.throwError(y.MISTAKE_METHOD,{className:e,prop:r})}})}static findClosestMethods(t,e,i=2){return e.map(s=>({name:s,distance:d.levenshteinDistance(t.toLowerCase(),s.toLowerCase())})).filter(({distance:s})=>s<=i).sort((s,r)=>s.distance-r.distance).map(({name:s})=>s).slice(0,3)}static levenshteinDistance(t,e){let i=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(0));for(let s=0;s<=t.length;s++)i[s][0]=s;for(let s=0;s<=e.length;s++)i[0][s]=s;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++){let o=t[s-1]===e[r-1]?0:1;i[s][r]=Math.min(i[s-1][r]+1,i[s][r-1]+1,i[s-1][r-1]+o)}return i[t.length][e.length]}};var W=class{constructor(){this.ready=!1}get width(){return this.image instanceof HTMLCanvasElement?this.image.width:0}get height(){return this.image instanceof HTMLCanvasElement?this.image.height:0}};var H=class{constructor(){this.callbacksMap=new Map;this.eventTarget=new EventTarget}once(t,e,i){if(this.callbacksMap.get(t))return!1;let s=r=>{typeof i=="function"?i(r):i.handleEvent(r),this.eventTarget.removeEventListener(e,s),this.remove(t)};return this.eventTarget.addEventListener(e,s),this.callbacksMap.set(t,{type:e,callback:s}),!0}on(t,e,i){return this.callbacksMap.get(t)?!1:(this.eventTarget.addEventListener(e,i),this.callbacksMap.set(t,{type:e,callback:i}),!0)}emit(t,e){this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:e}))}remove(t){let e=this.callbacksMap.get(t);return e?(this.eventTarget.removeEventListener(e.type,e.callback),this.callbacksMap.delete(t),!0):!1}removeByType(t){this.callbacksMap.forEach((e,i)=>{t===e.type&&(this.eventTarget.removeEventListener(e.type,e.callback),this.callbacksMap.delete(i))})}clearAll(){this.callbacksMap.forEach(t=>{this.eventTarget.removeEventListener(t.type,t.callback)}),this.callbacksMap.clear()}};var K=class K{constructor(t=null,e=null,i=null,s=null,r=!0,o="ru"){this.debugMode="none";this.debugCollider=!1;this.debugColor="red";this.stages=[];this.activeStage=null;this.styles=null;this.loadedStages=0;this.onReadyCallbacks=[];this.onUserInteractedCallbacks=[];this.onReadyPending=!0;this.running=!1;this.pendingRun=!1;this.reportedError=!1;this._displayErrors=!0;this._locale="ru";this._userInteracted=!1;this._displayErrors=r,this._locale=o,this.validatorFactory=new mt(this);let n=this;this.displayErrors&&(n=this.validatorFactory.createValidator(this,"Game")),window.onerror=()=>{n.reportError(y.getMessage(y.SCRIPT_ERROR,n._locale))},n.id=Symbol(),n.eventEmitter=new H,n.keyboard=new dt;let a=document.createElement("div");if(a.style.position="relative",document.body.appendChild(a),i){let l=document.getElementById(i);l instanceof HTMLCanvasElement&&(n.canvas=l)}else n.canvas=document.createElement("canvas");if(a.appendChild(n.canvas),s){let l=document.getElementById(s);l instanceof HTMLCanvasElement&&(n.canvasUI=l)}else n.canvasUI=document.createElement("canvas");return a.appendChild(n.canvasUI),n.canvasUI.style.position="absolute",n.canvasUI.style.left="0",n.canvasUI.style.top="0",n.canvas.width=t,n.canvas.height=e,n.canvasUI.width=t,n.canvasUI.height=e,n.styles=new st(n.canvas,t,e),new st(n.canvasUI,t,e),n.mouse=new ut(n),n.context=n.canvas.getContext("2d"),n.contextUI=n.canvasUI.getContext("2d"),k.getInstance().set("game",n),n.addListeners(),n}addStage(t){return this.stages.push(t),this}getLastStage(){return this.stages.length?this.stages[this.stages.length-1]:null}getActiveStage(){return this.activeStage?this.activeStage:null}run(t=null){if(!t&&this.stages.length&&(t=this.stages[0]),t||this.throwError(y.NEED_STAGE_BEFORE_RUN_GAME),!this.running)for(let e of this.stages)e.ready();this.activeStage&&this.activeStage.running&&this.activeStage.stop(),this.running=!1,this.pendingRun=!0,this.activeStage=t,this.tryDoRun()}isReady(){return this.loadedStages==this.stages.length}onReady(t){this.onReadyCallbacks.push(t)}onUserInteracted(t){this.onUserInteractedCallbacks.push(t)}stop(){this.activeStage&&this.activeStage.running&&this.activeStage.stop(),this.running=!1}get displayErrors(){return this._displayErrors}get locale(){return this._locale}get width(){return this.canvas.width}get height(){return this.canvas.height}get userInteracted(){return this._userInteracted}isInsideGame(t,e){return t>=0&&t<=this.width&&e>=0&&e<=this.height}correctMouseX(t){return t-this.styles.canvasRect.left}correctMouseY(t){return t-this.styles.canvasRect.top}keyPressed(t){if(Array.isArray(t)){for(let e of t)if(this.keyboard.keyPressed(e))return!0;return!1}return this.keyboard.keyPressed(t)}keyDown(t,e){this.keyboard.keyDown(t,e)}keyUp(t,e){this.keyboard.keyUp(t,e)}mouseDown(){return this.mouse.isMouseDown(this.activeStage)}mouseDownOnce(){let t=this.mouse.isMouseDown(this.activeStage);return this.mouse.clearMouseDown(),t}getMousePoint(){return this.mouse.getPoint()}getRandom(t,e){return Math.floor(Math.random()*(e-t+1))+t}throwError(t,e=null,i=!0){let s=y.getMessage(t,this.locale,e);this.throwErrorRaw(s,i)}throwErrorRaw(t,e=!0){throw e&&this.reportError(t),new Error(t)}reportError(t){this._displayErrors&&!this.reportedError&&(alert(t),this.reportedError=!0)}addListeners(){this.eventEmitter.on(K.STAGE_READY_EVENT,K.STAGE_READY_EVENT,t=>{this.loadedStages++,this.tryDoOnReady()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.activeStage&&this.activeStage.running&&this.activeStage.stop():this.activeStage&&this.activeStage.stopped&&this.activeStage.run()}),this.userInteractionPromise=new Promise(t=>{document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",e=>{["Control","Shift","CapsLock","NumLock","Alt","Meta"].includes(e.key)||t(!0)},{once:!0})})}tryDoOnReady(){if(this.isReady()&&this.onReadyPending){if(this.onReadyPending=!1,this.onReadyCallbacks.length){for(let t of this.onReadyCallbacks)t();this.onReadyCallbacks=[]}this.userInteractionPromise.then(()=>{this._userInteracted=!0,this.onUserInteractedCallbacks.filter(t=>(t(this),!1))}),this.tryDoRun()}}tryDoRun(){this.pendingRun&&!this.running&&this.isReady()&&(this.running=!0,this.pendingRun=!1,this.activeStage.run())}};K.STAGE_READY_EVENT="scrubjs.stage.ready",K.STAGE_BACKGROUND_READY_EVENT="scrubjs.stage.background_ready",K.SPRITE_READY_EVENT="scrubjs.sprite.ready";var D=K;var X=class{constructor(t,e,i,s){this.callback=t,this.state=e,this.timeout=i,this.finishCallback=s}};var B=class{constructor(t,e,i){this.interval=t,this.maxIterations=e,this.currentIteration=i}};var Q=class d{constructor(t,e=0,i=[]){this.name="No name";this.game=null;this.stage=null;this._parentSprite=null;this._collidedSprite=null;this._original=null;this.costumeIndex=null;this.costume=null;this.costumes=[];this.costumeNames=[];this.sounds=[];this.soundNames=[];this.currentColliderName=null;this.colliders=new Map;this.phrase=null;this.phraseLiveTime=null;this._x=0;this._y=0;this._pivotOffsetX=0;this._pivotOffsetY=0;this._width=0;this._height=0;this._defaultColliderNone=!1;this._direction=0;this._size=100;this._centerDistance=0;this._centerAngle=0;this._rotateStyle="normal";this._hidden=!1;this._opacity=null;this._filter=null;this._deleted=!1;this._stopped=!0;this.pendingCostumeGrids=0;this.pendingCostumes=0;this.pendingSounds=0;this._children=[];this.onReadyCallbacks=[];this.onReadyPending=!0;this.scheduledCallbacks=[];this.tempScheduledCallbacks=[];this._drawings=[];this._tags=[];if(!k.getInstance().has("game"))throw new Error("You need create Game instance before Stage instance.");this.game=k.getInstance().get("game");let s=this;this.game.displayErrors&&(s=this.game.validatorFactory.createValidator(this,"Sprite")),s.id=Symbol(),s.eventEmitter=new H,s.collisionResult=new M,s.stage=t,this.stage||(s.stage=this.game.getLastStage()),s.stage||s.game.throwError(y.NEED_CREATE_STAGE_BEFORE_SPRITE),s._layer=e,s._x=s.game.width/2,s._y=s.game.height/2;for(let r of i)s.addCostume(r);return s.scheduledCallbackExecutor=new Z(s),s.stage.addSprite(s),s.init(),s}init(){}onReady(t){this.onReadyCallbacks.push(t)}isReady(){return this.pendingCostumes===0&&this.pendingCostumeGrids===0&&this.pendingSounds===0}get deleted(){return this._deleted}get stopped(){return this._stopped}setParent(t){return t.addChild(this),this}addChild(t){if(!this._children.includes(t)){this._children.push(t),t.parent=this,t.layer=this.layer,t.x=0,t.y=0,t.direction=0;for(let e of this.tags)t.addTag(e)}return t.parent=this,this}removeChild(t){let e=this._children.indexOf(t);if(e>-1){let i=this._children[e];i.parent=null;for(let s of this.tags)i.removeTag(s);this._children.splice(e,1)}return this}getChildren(){return this._children}set parent(t){this._parentSprite=t}get parent(){return this._parentSprite}getMainSprite(){return this._parentSprite?this._parentSprite.getMainSprite():this}switchCollider(t){if(this.colliders.has(t)||this.game.throwError(y.COLLIDER_NAME_NOT_FOUND,{colliderName:t}),this.currentColliderName===t)return this;let e=this.collider;e&&this.stage.collisionSystem.remove(e),this.currentColliderName=t;let i=this.collider;return this.stage.collisionSystem.insert(i),this._width=i.width,this._height=i.height,this}setCollider(t,e,i=0,s=0){if(e.parentSprite=this,e.offset_x=i,e.offset_y=s,this.currentColliderName===t&&this.colliders.has(t)){let r=this.colliders.get(t);this.stage.collisionSystem.remove(r),this.currentColliderName=null}return this.colliders.set(t,e),this.updateColliderPosition(e),this.isReady()&&!this.collider&&this.switchCollider(t),this}setRectCollider(t,e,i,s=0,r=0){let o=0;this._rotateStyle!="leftRight"&&(o=this.globalAngleRadians);let n=new w(this.x,this.y,[[e/2*-1,i/2*-1],[e/2,i/2*-1],[e/2,i/2],[e/2*-1,i/2]],o,this.size/100,this.size/100);return n.width=e,n.height=i,this.setCollider(t,n,s,r),this}setPolygonCollider(t,e,i=0,s=0){let r=0;this._rotateStyle!="leftRight"&&(r=this.globalAngleRadians);let o=this.calculateCentroid(e),n=e.map(u=>[u[0]-o.x,u[1]-o.y]),a=new w(this.x,this.y,n,r,this.size/100,this.size/100),{width:l,height:h}=this.calculatePolygonSize(n);return a.width=l,a.height=h,this.setCollider(t,a,i,s),this}setCircleCollider(t,e,i=0,s=0){let r=new Y(this.x,this.y,e,this.size/100);return r.width=e*2,r.height=e*2,this.setCollider(t,r,i,s),this}setCostumeCollider(t,e=0,i=0,s=0){this.costumes[e]===void 0&&this.game.throwError(y.COSTUME_INDEX_NOT_FOUND,{costumeIndex:e});let r=this.costumes[e];return this.setRectCollider(t,r.width,r.height,i,s),this}removeCollider(t){if(t)this.removeColliderByName(t);else{let e=this.collider;e&&this.stage.collisionSystem.remove(e),this.colliders.clear(),this.currentColliderName=null,this.defaultColliderNone=!0}return this}removeColliderByName(t){let e=this.getCollider(t);if(this.colliders.delete(t),this.colliders.size===0&&(this.defaultColliderNone=!0),t===this.currentColliderName&&(this.stage.collisionSystem.remove(e),this.colliders.size)){let i=this.colliders.keys().next().value;this.switchCollider(i)}return this}getCollider(t){return this.colliders.has(t)||this.game.throwError(y.COLLIDER_NAME_NOT_FOUND,{colliderName:t}),this.colliders.get(t)}hasCollider(t){return this.colliders.has(t)}get collider(){return this.currentColliderName&&this.colliders.has(this.currentColliderName)?this.colliders.get(this.currentColliderName):null}get collidedSprite(){return this._collidedSprite}set defaultColliderNone(t){this._defaultColliderNone=t}get defaultColliderNone(){return this._defaultColliderNone}getColliders(){return this.colliders.entries()}cloneCollider(t){let e=t.getColliders();for(let[i,s]of e)s instanceof Y&&this.setCircleCollider(i,s.radius,s.offset_x,s.offset_y),s instanceof w&&this.setPolygonCollider(i,s.points,s.offset_x,s.offset_y)}calculateCentroid(t){let e=0,i=0;for(let o of t)e+=o[0],i+=o[1];let s=e/t.length,r=i/t.length;return{x:s,y:r}}calculatePolygonSize(t){let e=t[0][0],i=t[0][1],s=t[0][0],r=t[0][1];for(let a of t)a[0]<e&&(e=a[0]),a[0]>s&&(s=a[0]),a[1]<i&&(i=a[1]),a[1]>r&&(r=a[1]);let o=s-e,n=r-i;return{width:o,height:n}}updateColliderPosition(t){t.x=this.imageCenterX+t.center_offset_x*this.size/100,t.y=this.imageCenterY+t.center_offset_y*this.size/100}updateColliderAngle(){let t=this.collider;t instanceof w&&(this._rotateStyle=="leftRight"?t.angle=0:t.angle=this.globalAngleRadians),t&&this.updateColliderPosition(t)}updateColliderSize(t){t instanceof w?(t.scale_x=this.size/100,t.scale_y=this.size/100):t instanceof Y&&(t.scale=this.size/100)}addTag(t){this.hasTag(t)||this._tags.push(t);for(let e of this._children)e.addTag(t);return this}removeTag(t){let e=this._tags.indexOf(t);e>-1&&this._tags.splice(e,1);for(let i of this._children)i.addTag(t);return this}hasTag(t){return this._tags.includes(t)}get tags(){return this._tags}addCostume(t,e){let i=new W,s=this.costumes.length,r=(e?.name??"Costume")+"-"+s;this.costumes.push(i),this.costumeNames.push(r),this.pendingCostumes++;let o=new Image;o.src=t,e?.alphaColor&&(o.crossOrigin="anonymous");let n=()=>{if(this.deleted)return;let a=this.transformImage(o,e?.rotate??0,e?.flipX??!1,e?.flipY??!1,e?.x??0,e?.y??0,e?.width??o.naturalWidth,e?.height??o.naturalHeight,e?.alphaColor??null,e?.alphaTolerance??0,e?.crop??0,e?.cropTop??null,e?.cropRight??null,e?.cropBottom??null,e?.cropLeft??null);i.image=a,i.ready=!0,this.pendingCostumes--,this.tryDoOnReady(),o.removeEventListener("load",n)};return o.addEventListener("load",n),o.addEventListener("error",()=>{this.game.throwError(y.COSTUME_NOT_LOADED,{costumePath:t})}),this}addCostumeGrid(t,e){let i=new Image;i.src=t;let s=e?.name??"Costume";this.pendingCostumeGrids++;let r=()=>{i.naturalWidth,i.naturalHeight;let o=e.cols,n=e.rows,a=e.limit,l=e.offset,h=i.naturalWidth/o,u=i.naturalHeight/n,c=!1,m=0,p=0,_=0;for(let f=0;f<n;f++){for(let b=0;b<o;b++){if(c=!1,l!==null&&l>0&&(l--,c=!0),!c){if(a!==null){if(a==0)break;a>0&&a--}let v=new W;this.costumes.push(v),this.costumeNames.push(s+"-"+m);let C=this.transformImage(i,e?.rotate??0,e?.flipX??!1,e?.flipY??!1,p+(e?.x??0),_+(e?.y??0),e?.width??h,e?.height??u,e?.alphaColor??null,e?.alphaTolerance??0,e?.crop??0,e?.cropTop??null,e?.cropRight??null,e?.cropBottom??null,e?.cropLeft??null);v.image=C,v.ready=!0,m++}p+=h}p=0,_+=u}this.pendingCostumeGrids--,this.tryDoOnReady(),i.removeEventListener("load",r)};return i.addEventListener("load",r),this}drawCostume(t,e){let i=document.createElement("canvas"),s=i.getContext("2d");i.width=e?.width??100,i.height=e?.height??100,this.pendingCostumes++,t(s,this);let r=this.costumes.length,o=(e?.name??"Costume")+"-"+r;Object.values(e||{}).some(l=>!!l)&&(i=this.transformImage(i,e?.rotate??0,e?.flipX??!1,e?.flipY??!1,e?.x??0,e?.y??0,e?.width??i.width,e?.height??i.height,e?.alphaColor??null,e?.alphaTolerance??0,e?.crop??0,e?.cropTop??null,e?.cropRight??null,e?.cropBottom??null,e?.cropLeft??null));let a=new W;return a.image=i,a.ready=!0,this.costumes.push(a),this.costumeNames.push(o+"-"+r),this.pendingCostumes--,this}removeCostume(t){return this.costumes[t]===void 0&&this.game.throwError(y.COSTUME_INDEX_NOT_FOUND,{costumeIndex:t}),this.costumes.splice(t,1),this.costumeNames.splice(t,1),this.costumeIndex===t&&(this.costumeIndex=null,this.costumes.length>0?this.nextCostume():this.costume=null),this}switchCostume(t){if(this.deleted)return;this.isReady()||this.game.throwError(y.COSTUME_SWITCH_NOT_READY);let e=this.costumes[t];return e instanceof W&&e.ready&&(this.costumeIndex=t,this.costume=e),this}switchCostumeByName(t){this.isReady()||this.game.throwError(y.COSTUME_SWITCH_NOT_READY);let e=this.costumeNames.indexOf(t);return e>-1?this.switchCostume(e):this.game.throwError(y.COSTUME_NAME_NOT_FOUND,{costumeName:t}),this}nextCostume(t=0,e){if(this.deleted)return;this.isReady()||this.game.throwError(y.COSTUME_SWITCH_NOT_READY);let i=this.costumes.length-1;t=Math.min(i,Math.max(0,t)),e=Math.min(i,Math.max(0,e??i));let s=this.costumeIndex+1;return(s>e||s<t)&&(s=t),s!==this.costumeIndex&&this.switchCostume(s),s}prevCostume(t=0,e){if(this.deleted)return;this.isReady()||this.game.throwError(y.COSTUME_SWITCH_NOT_READY);let i=this.costumes.length-1;t=Math.min(i,Math.max(0,t)),e=Math.min(i,Math.max(0,e??i));let s=this.costumeIndex-1;return(s<t||s>e)&&(s=e),s!==this.costumeIndex&&this.switchCostume(s),s}getCostume(){return this.costume}getCostumeName(){return this.costumeIndex===null?"No costume":this.costumeNames[this.costumeIndex]}getCostumeIndex(){return this.costumeIndex}transformImage(t,e,i=!1,s=!1,r=0,o=0,n=null,a=null,l=null,h=0,u=0,c=null,m=null,p=null,_=null){c=c??u,m=m??u,p=p??u,_=_??u,r+=m,n-=m,n-=_,o+=c,a-=c,a-=p;let f=document.createElement("canvas"),b=f.getContext("2d"),v=e*Math.PI/180,C=n??(t instanceof HTMLImageElement?t.naturalWidth:t.width),S=a??(t instanceof HTMLImageElement?t.naturalHeight:t.height);if(e){let U=Math.abs(Math.cos(v)),J=Math.abs(Math.sin(v));C=C*U+S*J,S=C*J+S*U}f.width=Math.ceil(C),f.height=Math.ceil(S),b.translate(f.width/2,f.height/2),e&&b.rotate(v),(i||s)&&b.scale(i?-1:1,s?-1:1);let E=-n/2,I=-a/2;return b.drawImage(t,r,o,n,a,E,I,n,a),l&&(f=this.setAlpha(f,l,h??0)),f}setAlpha(t,e,i=0){let s=document.createElement("canvas"),r=s.getContext("2d");if(!r)throw new Error("Canvas context is not available");s.width=t.width,s.height=t.height;let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=o.data,a;if(typeof e=="string"){if(a=this.hexToRgb(e),!a)throw new Error(`Invalid HEX color: ${e}`)}else a=e;for(let l=0;l<n.length;l+=4){let h=n[l],u=n[l+1],c=n[l+2];Math.abs(h-a.r)<=i&&Math.abs(u-a.g)<=i&&Math.abs(c-a.b)<=i&&(n[l+3]=0)}return r.putImageData(o,0,0),s}hexToRgb(t){if(t=t.replace(/^#/,""),t.length===3&&(t=t.split("").map(i=>i+i).join("")),t.length!==6)return null;let e=parseInt(t,16);return{r:e>>16&255,g:e>>8&255,b:e&255}}cloneCostume(t,e){this.costumes.push(t),this.costumeNames.push(e)}addSound(t,e){this.soundNames.includes(e)&&this.game.throwError(y.SOUND_NAME_ALREADY_EXISTS,{soundName:e});let i=new Audio;i.src=t,this.sounds.push(i),this.soundNames.push(e),this.pendingSounds++,i.load();let s=()=>{this.pendingSounds--,this.tryDoOnReady(),i.removeEventListener("loadedmetadata",s)};return i.addEventListener("loadedmetadata",s),this}removeSound(t){let e=this.soundNames.indexOf(t);return e<0&&this.game.throwError(y.SOUND_NAME_NOT_FOUND,{soundName:t}),this.sounds.splice(e,1),this}playSound(t,e={}){let i=this.getSound(t);this.doPlaySound(i,e)}startSound(t,e={}){let i=this.cloneSound(t);return this.doPlaySound(i,e),i}pauseSound(t){this.getSound(t).pause()}getSound(t){this.isReady()||this.game.throwError(y.SOUND_USE_NOT_READY);let e=this.soundNames.indexOf(t);e<0&&this.game.throwError(y.SOUND_NAME_NOT_FOUND,{soundName:t});let i=this.sounds[e];return i instanceof Audio||this.game.throwError(y.SOUND_INDEX_NOT_FOUND,{soundIndex:e}),i}cloneSound(t){let e=this.getSound(t);return new Audio(e.src)}doPlaySound(t,e={}){e.volume!==void 0&&(t.volume=e.volume),e.currentTime!==void 0&&(t.currentTime=e.currentTime),e.loop!==void 0&&(t.loop=e.loop);let i=t.play();i!==void 0&&i.catch(s=>{s.name==="NotAllowedError"?this.game.throwError(y.SOUND_NOT_ALLOWED_ERROR,{},!1):console.error("Audio playback error:",s)})}stamp(t,e=!0){this.isReady()||this.game.throwError(y.STAMP_NOT_READY),t=t??this.costumeIndex,this.costumes[t]||this.game.throwError(y.STAMP_COSTUME_NOT_FOUND,{costumeIndex:t});let i=this.costumes[t];i.image instanceof HTMLCanvasElement||this.game.throwErrorRaw("The image inside the costume was not found.");let s=0;e&&this._rotateStyle==="normal"&&(s=this.direction),this.stage.stampImage(i.image,this.x,this.y,s)}pen(t){this._drawings.push(t)}get drawings(){return this._drawings}set opacity(t){t===null?this._opacity=null:this._opacity=Math.min(1,Math.max(0,t))}get opacity(){return this._opacity}set filter(t){this._filter=t}get filter(){return this._filter}set rotateStyle(t){this._rotateStyle=t;for(let e of this._children)e.rotateStyle=t}get rotateStyle(){return this._rotateStyle}set layer(t){this.stage.changeSpriteLayer(this,this._layer,t),this._layer=t;for(let e of this._children)e.layer=e.layer+this._layer}get layer(){return this._layer}set hidden(t){this._hidden=t;for(let e of this._children)e.hidden=t}get hidden(){return this._hidden}say(t,e){if(this.phrase=this.name+": "+t,this.phraseLiveTime=null,e){let i=new Date().getTime();this.phraseLiveTime=i+e}}getPhrase(){if(this.phrase){if(this.phraseLiveTime===null)return this.phrase;let t=new Date().getTime();if(this.phraseLiveTime>t)return this.phrase;this.phrase=null,this.phraseLiveTime=null}return null}move(t){let e=this.globalAngleRadians;this.x+=t*Math.sin(e),this.y-=t*Math.cos(e)}pointForward(t){let e=t.globalX?t.globalX:t.x,i=t.globalY?t.globalY:t.y;this.globalDirection=Math.atan2(this.globalY-i,this.globalX-e)/Math.PI*180-90}getDistanceTo(t){let e=t.globalX?t.globalX:t.x,i=t.globalY?t.globalY:t.y;return Math.sqrt(Math.abs(this.globalX-e)+Math.abs(this.globalY-i))}bounceOnEdge(){(this.touchTopEdge()||this.touchBottomEdge())&&(this.direction=180-this.direction),(this.touchLeftEdge()||this.touchRightEdge())&&(this.direction*=-1)}set x(t){this._x=t,this._children.length&&this.updateCenterParams();let e=this.collider;e&&this.updateColliderPosition(e);for(let i of this._children)i.collider&&i.updateColliderPosition(i.collider)}get x(){return this._x}set y(t){this._y=t,this._children.length&&this.updateCenterParams();let e=this.collider;e&&this.updateColliderPosition(e);for(let i of this._children)i.collider&&i.updateColliderPosition(i.collider)}get y(){return this._y}get globalX(){return this._parentSprite?this._rotateStyle==="leftRight"||this._rotateStyle==="none"?this._parentSprite.imageCenterX+this._x*this.size/100:this._parentSprite.imageCenterX+this.distanceToParent*Math.cos(this.angleToParent-this._parentSprite.globalAngleRadians)*this.size/100:this._x}get globalY(){return this._parentSprite?this._rotateStyle==="leftRight"||this._rotateStyle==="none"?this._parentSprite.imageCenterY+this._y:this._parentSprite.imageCenterY-this.distanceToParent*Math.sin(this.angleToParent-this._parentSprite.globalAngleRadians)*this.size/100:this._y}get imageCenterX(){if(this._rotateStyle==="leftRight"||this._rotateStyle==="none"){let t=this._direction>180&&this._rotateStyle==="leftRight"?-1:1;return this.globalX-this._pivotOffsetX*t*this.size/100}return this.globalX+Math.cos(this._centerAngle-this.globalAngleRadians)*this._centerDistance*this.size/100}get imageCenterY(){return this._rotateStyle==="leftRight"||this._rotateStyle==="none"?this.globalY-this._pivotOffsetY*this.size/100:this.globalY-Math.sin(this._centerAngle-this.globalAngleRadians)*this._centerDistance*this.size/100}get realX(){return this.x-this.width/2}get realY(){return this.y-this.height/2}get rightX(){let t=this.collider,e=t?t.center_offset_x*this.size/100:0;return this.imageCenterX+this.width/2+e}set rightX(t){let e=this.collider,i=e?e.center_offset_x*this.size/100:0;this.x=t-this.width/2-i}get leftX(){let t=this.collider,e=t?t.center_offset_x*this.size/100:0;return this.imageCenterX-this.width/2+e}set leftX(t){let e=this.collider,i=e?e.center_offset_x*this.size/100:0;this.x=t+this.width/2+i}get topY(){let t=this.collider,e=t?t.center_offset_y*this.size/100:0;return this.imageCenterY-this.height/2+e}set topY(t){let e=this.collider,i=e?e.center_offset_y*this.size/100:0;this.y=t+this.height/2+i}get bottomY(){let t=this.collider,e=t?t.center_offset_y*this.size/100:0;return this.imageCenterY+this.height/2+e}set bottomY(t){let e=this.collider,i=e?e.center_offset_y*this.size/100:0;this.y=t-this.height/2-i}get width(){if(this.collider instanceof w){let t=this.globalAngleRadians;return Math.abs(this.sourceWidth*Math.cos(t))+Math.abs(this.sourceHeight*Math.sin(t))}return this.sourceWidth}get height(){if(this.collider instanceof w){let t=this.globalAngleRadians;return Math.abs(this.sourceWidth*Math.sin(t))+Math.abs(this.sourceHeight*Math.cos(t))}return this.sourceHeight}get sourceWidth(){return this._width*this.size/100}get sourceHeight(){return this._height*this.size/100}set size(t){this._size=t;let e=this.collider;e&&this.updateColliderSize(e);for(let i of this._children)i.size=t}get size(){return this._size}set direction(t){if(t*0===0){t=t%360,t<0&&(t+=360),this._direction=t>360?t-360:t,this.updateColliderAngle();for(let e of this._children)e.updateColliderAngle()}}get direction(){return this._direction}set globalDirection(t){this.direction=this._parentSprite?t-this._parentSprite.direction:t}get globalDirection(){return this._parentSprite?this._parentSprite.direction+this.direction:this.direction}get globalAngleRadians(){return this.globalDirection*Math.PI/180}get angleToParent(){return-Math.atan2(this.y,this.x)}get distanceToParent(){return Math.hypot(this.x,this.y)}setPivotOffset(t=0,e=0){return this.pivotOffsetX=t,this.pivotOffsetY=e,this}set pivotOffsetX(t){let e=this.x;this._pivotOffsetX=t,this.updateCenterParams(),this.x=e}get pivotOffsetX(){return this._pivotOffsetX}set pivotOffsetY(t){let e=this.y;this._pivotOffsetY=t,this.updateCenterParams(),this.y=e}get pivotOffsetY(){return this._pivotOffsetY}updateCenterParams(){this._centerDistance=Math.hypot(this._pivotOffsetX,this._pivotOffsetY),this._centerAngle=-Math.atan2(-this._pivotOffsetY,-this._pivotOffsetX)}touchSprite(t,e=!0){if(this._collidedSprite=null,t.hidden||this.hidden||t.stopped||this.stopped||t.deleted||this.deleted)return!1;let i=this.collider,s=t.collider;if(i&&s&&i.collides(s,this.collisionResult))return!0;if(i){for(let o of t.getChildren())if(this.touchSprite(o,!1))return!0}if(!e)return!1;for(let o of this._children){if(s&&o.touchSprite(t))return this._collidedSprite=o,!0;for(let n of t.getChildren())if(o.touchSprite(n))return this._collidedSprite=o,!0}return!1}touchSprites(t,e=!0){if(this.hidden||this.stopped||this.deleted)return!1;for(let i of t)if(this.touchSprite(i,e))return!0;return!1}touchMouse(t=!0){return this.touchPoint(this.game.getMousePoint(),t)}touchPoint(t,e=!0){if(this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;let i=this.collider;if(i&&i.collides(t,this.collisionResult))return!0;if(e){for(let r of this._children)if(r.touchPoint(r.game.getMousePoint()))return this._collidedSprite=r.otherSprite,!0}return!1}touchEdge(t=!0){let e=this.getPureCollisionResult();if(this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider){let i=this.game.width,s=this.game.height;if(this.topY<0)return e.collision=!0,e.overlap=-this.topY,e.overlap_y=-1,!0;if(this.bottomY>s)return e.collision=!0,e.overlap=this.bottomY-s,e.overlap_y=1,!0;if(this.leftX<0)return e.collision=!0,e.overlap=-this.leftX,e.overlap_x=-1,!0;if(this.rightX>i)return e.collision=!0,e.overlap=this.rightX-i,e.overlap_x=1,!0}if(t){for(let i of this._children)if(i.touchEdge())return this._collidedSprite=i,!0}return!1}touchTopEdge(t=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.topY<0)return this.collisionResult.collision=!0,this.collisionResult.overlap=-this.topY,this.collisionResult.overlap_y=-1,!0;if(t){for(let e of this._children)if(e.touchTopEdge())return this._collidedSprite=e,!0}return!1}touchBottomEdge(t=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.bottomY>this.game.height)return this.collisionResult.collision=!0,this.collisionResult.overlap=this.bottomY-this.game.height,this.collisionResult.overlap_y=1,!0;if(t){for(let e of this._children)if(e.touchBottomEdge())return this._collidedSprite=e,!0}return!1}touchLeftEdge(t=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.leftX<0)return this.collisionResult.collision=!0,this.collisionResult.overlap=-this.leftX,this.collisionResult.overlap_x=-1,!0;if(t){for(let e of this._children)if(e.touchLeftEdge())return this._collidedSprite=e,!0}return!1}touchRightEdge(t=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.rightX>this.game.width)return this.collisionResult.collision=!0,this.collisionResult.overlap=this.rightX-this.game.width,this.collisionResult.overlap_x=1,!0;if(t){for(let e of this._children)if(e.touchRightEdge())return this._collidedSprite=e,!0}return!1}touchTag(t,e=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;let i=this.collider;if(i){let s=i.potentials();if(!s.length)return!1;for(let r of s){let o=r.parentSprite;if(o&&o.hasTag(t)&&!o.hidden&&!o.stopped&&!o.deleted&&i.collides(r,this.collisionResult))return!0}}if(e){for(let s of this._children)if(s.touchTag(t))return this._collidedSprite=s,!0}return!1}touchTagAll(t,e=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;let i=[],s=this.collider;if(s){let r=s.potentials();if(!r.length)return!1;for(let o of r){let n=o.parentSprite;n&&n.hasTag(t)&&!n.hidden&&!n.stopped&&!n.deleted&&n.collider&&s.collides(o,this.collisionResult)&&i.push(n)}}if(e)for(let r of this._children){let o=r.touchTagAll(t);if(o&&!o.length)for(let n of o)i.push(n)}return i.length?i:!1}touchAnySprite(t=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;let e=this.collider;if(e){let i=e.potentials();if(!i.length)return!1;for(let s of i){let r=s.parentSprite;if(!r.hidden&&!r.stopped&&!r.deleted&&e.collides(s,this.collisionResult))return!0}}if(t){for(let i of this._children)if(i.touchAnySprite())return this._collidedSprite=i,!0}return!1}get overlap(){return this._collidedSprite?this._collidedSprite.overlap:this.collisionResult.collision?this.collisionResult.overlap:0}get overlapX(){return this._collidedSprite?this._collidedSprite.overlapX:this.collisionResult.collision?this.collisionResult.overlap_x*this.collisionResult.overlap:0}get overlapY(){return this._collidedSprite?this._collidedSprite.overlapY:this.collisionResult.collision?this.collisionResult.overlap_y*this.collisionResult.overlap:0}get otherSprite(){return this.collisionResult.collision?this.collisionResult.b.parentSprite:null}get otherMainSprite(){return this.collisionResult.collision?this.collisionResult.b.parentSprite.getMainSprite():null}clearCollisionResult(){this.collisionResult.collision=!1,this.collisionResult.a=null,this.collisionResult.b=null,this.collisionResult.a_in_b=!1,this.collisionResult.b_in_a=!1,this.collisionResult.overlap=0,this.collisionResult.overlap_x=0,this.collisionResult.overlap_y=0}getPureCollisionResult(){return this.clearCollisionResult(),this.collisionResult}timeout(t,e){this.repeat(t,1,null,e,void 0)}repeat(t,e,i,s,r){let o=new B(i,e,0);return s&&(s=Date.now()+s),this.tempScheduledCallbacks.push(new X(t,o,s,r)),o}forever(t,e,i,s){let r=new B(e);return i&&(i=Date.now()+i),this.tempScheduledCallbacks.push(new X(t,r,i,s)),r}update(t){this.deleted||(this.tempScheduledCallbacks.length&&(this.scheduledCallbacks=this.scheduledCallbacks.concat(this.tempScheduledCallbacks),this.tempScheduledCallbacks=[]),this.scheduledCallbacks=this.scheduledCallbacks.filter(this.scheduledCallbackExecutor.execute(Date.now(),t)))}run(){this._stopped=!1}stop(){this._stopped=!0}ready(){this.tryDoOnReady()}get original(){return this._original}setOriginal(t){this._original=t}createClone(t){this.isReady()||this.game.throwError(y.CLONED_NOT_READY),t||(t=this.stage);let e=new d(t,this.layer);e.setOriginal(this),e.name=this.name,e._rotateStyle=this._rotateStyle,e.x=this.x,e.y=this.y,e.pivotOffsetX=this.pivotOffsetX,e.pivotOffsetY=this.pivotOffsetY,e.direction=this.direction,e.size=this.size,e.hidden=this.hidden,e._deleted=this.deleted,e._stopped=this.stopped,e._tags.push(...this.tags),e.defaultColliderNone=this.defaultColliderNone;for(let i=0;i<this.costumes.length;i++)e.cloneCostume(this.costumes[i],this.costumeNames[i]);e.switchCostume(this.costumeIndex);for(let[i,s]of this.sounds.entries())e.sounds.push(s),e.soundNames.push(this.soundNames[i]);e.currentColliderName=null,e.cloneCollider(this),this.currentColliderName&&e.switchCollider(this.currentColliderName);for(let i of this._children){let s=i.createClone();e.addChild(s),s.x=i.x,s.y=i.y,s.direction=i.direction}return e.ready(),e}delete(){if(this.deleted)return;this.stage.removeSprite(this,this.layer),this.eventEmitter.clearAll(),this.removeCollider(),this.scheduledCallbackExecutor=null;for(let e of this._children)e.delete();let t=Object.keys(this);for(let e=0;e<t.length;e++)delete this[t[e]];this.costumes=[],this.costumeNames=[],this.sounds=[],this.soundNames=[],this.onReadyCallbacks=[],this.tempScheduledCallbacks=[],this.scheduledCallbacks=[],this._children=[],this._deleted=!0}deleteClones(){this.stage.getSprites().filter(e=>e.original===this).forEach(e=>e.delete())}tryDoOnReady(){if(this.onReadyPending&&this.isReady()){if(this.onReadyPending=!1,this.costumes.length&&this.costume===null&&this.switchCostume(0),!this.defaultColliderNone&&this.colliders.size===0&&this.costumes.length){let t="main";this.setCostumeCollider(t,0),this.switchCollider(t),this.updateColliderPosition(this.collider),this.updateColliderSize(this.collider)}if(!this.collider&&this.colliders.size){let t=this.colliders.keys().next().value;this.switchCollider(t),this.updateColliderPosition(this.collider),this.updateColliderSize(this.collider)}if(this.onReadyCallbacks.length){for(let t of this.onReadyCallbacks)t();this.onReadyCallbacks=[]}this.stage.eventEmitter.emit(D.SPRITE_READY_EVENT,{sprite:this,stageId:this.stage.id})}}};var Z=class{constructor(t){this.context=t}execute(t,e){return i=>{let s=i.state;if(this.context instanceof Q){if(this.context.deleted)return!1;if(this.context.stopped)return!0}if(i.timeout&&e&&(i.timeout+=e),!i.timeout||i.timeout<=t){let r=i.callback.bind(this.context)(this.context,s);if(s.maxIterations&&s.currentIteration++,r===!1||i.timeout&&!s.interval&&!s.maxIterations||s.maxIterations&&s.currentIteration>=s.maxIterations)return i.finishCallback&&i.finishCallback(this.context,s),!1;s.interval&&(i.timeout=t+s.interval)}return!0}}};var _t=class{constructor(){this.x=0;this.y=0;this.zoom=1;this.direction=0}reset(){this.x=0,this.y=0,this.zoom=1,this.direction=0}};var pt=class{constructor(t){this._direction=0;this._zoom=1;this.stage=t,this._x=this.stage.width/2,this._y=this.stage.height/2,this.updateRenderRadius(),this.changes=new _t}set direction(t){let e=t%360;e=e<0?e+360:e,this.changes.direction=e-this._direction,this._direction=e}get direction(){return this._direction}get angleDirection(){return this._direction*Math.PI/180}get width(){return this.stage.width/this._zoom}get height(){return this.stage.height/this._zoom}set x(t){this.changes.x=t-this._x,this._x=t}get x(){return this._x}set y(t){this.changes.y=t-this._y,this._y=t}get y(){return this._y}get startCornerX(){return this._x-this.stage.width/2}get startCornerY(){return this._y-this.stage.height/2}get renderRadius(){return this._renderRadius}set zoom(t){if(this.changes.zoom==1){let e=t<.1?.1:t;this.changes.zoom=e/this._zoom,this._zoom=e,this.updateRenderRadius()}}get zoom(){return this._zoom}updateRenderRadius(){this._renderRadius=Math.hypot(this.width,this.height)/1.7}};var Ot=class{constructor(t=null){this.background=null;this.backgroundIndex=null;this.backgrounds=[];this.sprites=new Map;this.drawings=new Map;this.drawingsUI=new Map;this.sounds=[];this.soundNames=[];this.addedSprites=0;this.loadedSprites=0;this.pendingBackgrounds=0;this.pendingSounds=0;this.pendingRun=!1;this.onReadyPending=!0;this.onReadyCallbacks=[];this.onStartCallbacks=[];this.scheduledCallbacks=[];this.tempScheduledCallbacks=[];this._stopped=!0;this._running=!1;this.stoppedTime=null;this.diffTime=null;if(!k.getInstance().has("game"))throw new Error("You need create Game instance before Stage instance.");this.game=k.getInstance().get("game");let e=this;return this.game.displayErrors&&(e=this.game.validatorFactory.createValidator(this,"Stage")),e.id=Symbol(),e.eventEmitter=new H,e.collisionSystem=new ht,e.canvas=e.game.canvas,e.context=e.game.context,e.contextUI=e.game.contextUI,t&&e.addBackground(t),e.addListeners(),e.game.addStage(e),e.scheduledCallbackExecutor=new Z(e),e.stoppedTime=Date.now(),e.init(),e.camera=new pt(e),e}init(){}onStart(t){this.onStartCallbacks.push(t)}onReady(t){this.onReadyCallbacks.push(t)}get running(){return this._running}get stopped(){return this._stopped}isReady(){return this.addedSprites==this.loadedSprites&&this.pendingBackgrounds===0}get width(){return this.canvas.width}get height(){return this.canvas.height}set backgroundColor(t){this.drawBackground((e,i)=>{e.fillStyle=t,e.fillRect(0,0,i.width,i.height)})}drawBackground(t){let e=document.createElement("canvas"),i=e.getContext("2d");return e.width=this.width,e.height=this.height,this.pendingBackgrounds++,t(i,this),this.backgrounds.push(e),this.pendingBackgrounds--,this}addBackground(t){let e=new Image;e.src=t,this.pendingBackgrounds++;let i=()=>{let s=document.createElement("canvas"),r=s.getContext("2d");s.width=this.width,s.height=this.height,r.drawImage(e,0,0,this.width,this.height),this.backgrounds.push(s),this.pendingBackgrounds--,this.tryDoOnReady(),this.tryDoRun(),e.removeEventListener("load",i)};return e.addEventListener("load",i),e.addEventListener("error",()=>{this.game.throwError(y.BACKGROUND_NOT_LOADED,{backgroundPath:t})}),this}switchBackground(t){this.backgroundIndex=t;let e=this.backgrounds[t];e&&(this.background=e)}nextBackground(){let t=this.backgroundIndex+1;t>this.backgrounds.length-1&&(t=0),t!==this.backgroundIndex&&this.switchBackground(t)}addSound(t,e){this.soundNames.includes(e)&&this.game.throwError(y.SOUND_NAME_ALREADY_EXISTS,{soundName:e});let i=new Audio;i.src=t,this.sounds.push(i),this.soundNames.push(e),this.pendingSounds++,i.load();let s=()=>{this.pendingSounds--,this.tryDoOnReady(),i.removeEventListener("loadedmetadata",s)};return i.addEventListener("loadedmetadata",s),this}removeSound(t){let e=this.soundNames.indexOf(t);return e<0&&this.game.throwError(y.SOUND_NAME_NOT_FOUND,{soundName:t}),this.sounds.splice(e,1),this}playSound(t,e={}){let i=this.getSound(t);this.doPlaySound(i,e)}startSound(t,e={}){let i=this.cloneSound(t);return this.doPlaySound(i,e),i}pauseSound(t){this.getSound(t).pause()}getSound(t){this.isReady()||this.game.throwError(y.SOUND_USE_NOT_READY);let e=this.soundNames.indexOf(t);e<0&&this.game.throwError(y.SOUND_NAME_NOT_FOUND,{soundName:t});let i=this.sounds[e];return i instanceof Audio||this.game.throwError(y.SOUND_INDEX_NOT_FOUND,{soundIndex:e}),i}cloneSound(t){let e=this.getSound(t);return new Audio(e.src)}doPlaySound(t,e={}){e.volume!==void 0&&(t.volume=e.volume),e.currentTime!==void 0&&(t.currentTime=e.currentTime),e.loop!==void 0&&(t.loop=e.loop);let i=t.play();i!==void 0&&i.catch(s=>{s.name==="NotAllowedError"?this.game.throwError(y.SOUND_NOT_ALLOWED_ERROR,{},!1):console.error("Audio playback error:",s)})}addSprite(t){let e;return this.sprites.has(t.layer)?e=this.sprites.get(t.layer):(e=[],this.sprites.set(t.layer,e)),e.push(t),this.addedSprites++,this}removeSprite(t,e){this.sprites.has(e)||this.game.throwErrorRaw('The layer "'+e+'" not defined in the stage.');let i=this.sprites.get(e);return i.splice(i.indexOf(t),1),i.length||this.sprites.delete(e),(t.deleted||t.isReady())&&this.loadedSprites--,this.addedSprites--,this}getSprites(){return Array.from(this.sprites.values()).reduce((t,e)=>t.concat(e),[])}changeSpriteLayer(t,e,i){this.sprites.has(e)||this.game.throwErrorRaw('The layer "'+e+'" not defined in the stage.');let s=this.sprites.get(e);s.splice(s.indexOf(t),1),s.length||this.sprites.delete(e);let r=[];this.sprites.has(i)?r=this.sprites.get(i):this.sprites.set(i,r),r.push(t)}drawSprite(t){let e=t.getCostume(),i=e.image,s=t.imageCenterX-t.sourceWidth/2,r=t.imageCenterY-t.sourceHeight/2,o=t.sourceWidth,n=t.sourceHeight,a=t.globalDirection,l=t.rotateStyle,h=(t.sourceWidth-e.width*t.size/100)/2,u=(t.sourceHeight-e.height*t.size/100)/2,c=l==="normal"&&a!==0||l==="leftRight"&&a>180||t.opacity!==null||t.filter!==null&&t.filter!="";c&&this.context.save(),t.opacity!==null&&(this.context.globalAlpha=t.opacity),t.filter&&(this.context.filter=t.filter),l==="normal"&&a!==0&&(this.context.translate(s+o/2,r+n/2),this.context.rotate(t.globalAngleRadians),this.context.translate(-s-o/2,-r-n/2)),l==="leftRight"&&a>180?(this.context.scale(-1,1),this.context.drawImage(i,0,0,e.width,e.height,-s-o+h,r+u,e.width*t.size/100,e.height*t.size/100)):this.context.drawImage(i,0,0,e.width,e.height,s+h,r+u,e.width*t.size/100,e.height*t.size/100),c&&this.context.restore()}stampImage(t,e,i,s=0){if(this.background instanceof HTMLCanvasElement){let r=document.createElement("canvas"),o=r.getContext("2d");r.width=this.width,r.height=this.height,o.drawImage(this.background,0,0,this.width,this.height);let n=t instanceof HTMLImageElement?t.naturalWidth:t.width,a=t instanceof HTMLImageElement?t.naturalHeight:t.height,l=e-n/2,h=i-a/2;if(s!==0){let u=s*Math.PI/180;o.translate(l+n/2,h+a/2),o.rotate(u),o.translate(-l-n/2,-h-a/2)}o.drawImage(t,l,h,n,a),this.background=r,this.backgrounds[this.backgroundIndex]=this.background}}pen(t,e=0){let i;this.drawings.has(e)?i=this.drawings.get(e):(i=[],this.drawings.set(e,i)),i.push(t)}ui(t,e=0){let i;this.drawingsUI.has(e)?i=this.drawingsUI.get(e):(i=[],this.drawingsUI.set(e,i)),i.push(t)}timeout(t,e){this.repeat(t,1,null,e,void 0)}repeat(t,e,i=null,s=null,r){let o=new B(i,e,0);return s&&(s=Date.now()+s),this.tempScheduledCallbacks.push(new X(t,o,s,r)),o}forever(t,e=null,i=null,s){let r=new B(e);return i&&(i=Date.now()+i),this.tempScheduledCallbacks.push(new X(t,r,i,s)),r}render(){this.update(),this.collisionSystem.update(),this.context.clearRect(this.camera.startCornerX-this.camera.width/this.camera.zoom/2,this.camera.startCornerY-this.camera.height/this.camera.zoom/2,this.width+this.camera.width/this.camera.zoom,this.height+this.camera.height/this.camera.zoom),this.background&&this.context.drawImage(this.background,0,0,this.width,this.height);let t=Array.from(this.sprites.keys()).concat(Array.from(this.drawings.keys()));t=t.filter((r,o)=>t.indexOf(r)===o),t=t.sort((r,o)=>r-o);for(let r of t){if(this.drawings.has(r)){let o=this.drawings.get(r);for(let n of o)n(this.context,this)}if(this.sprites.has(r)){let o=this.sprites.get(r);for(let n of o){if(n.hidden)continue;let a=Math.hypot(n.imageCenterX-this.camera.x,n.imageCenterY-this.camera.y),l=Math.hypot(n.sourceWidth,n.sourceHeight)/2*this.camera.zoom;if(a>this.camera.renderRadius+l)continue;if(this.game.debugMode!=="none"){let u=()=>{let c=n.imageCenterX-this.context.measureText(n.name).width/2,m=n.imageCenterY+n.height+20;this.context.fillStyle=this.game.debugColor,this.context.font="16px Arial",this.context.fillText(n.name,c,m),m+=20,this.context.font="14px Arial",this.context.fillText("x: "+n.x,c,m),m+=20,this.context.fillText("y: "+n.y,c,m),m+=20,this.context.fillText("direction: "+n.direction,c,m),m+=20,this.context.fillText("costume: "+n.getCostumeName(),c,m),m+=20,this.context.fillText("xOffset: "+n.pivotOffsetX,c,m),m+=20,this.context.fillText("yOffset: "+n.pivotOffsetY,c,m),this.context.beginPath(),this.context.moveTo(n.globalX-2,n.globalY),this.context.lineTo(n.globalX+2,n.globalY),this.context.moveTo(n.globalX,n.globalY-2),this.context.lineTo(n.globalX,n.globalY+2),this.context.stroke()};this.game.debugMode==="hover"&&n.touchMouse()&&u(),this.game.debugMode==="forever"&&u()}let h=n.getPhrase();h&&(this.context.font="20px Arial",this.context.fillStyle="black",this.context.fillText(h,40,this.canvas.height-40)),n.getCostume()&&this.drawSprite(n);for(let u of n.drawings)u(this.context,n)}}}let e=Array.from(this.drawingsUI.keys());e=e.filter((r,o)=>e.indexOf(r)===o),e=e.sort((r,o)=>r-o);for(let r of e)if(this.drawingsUI.has(r)){let o=this.drawingsUI.get(r);for(let n of o)n(this.contextUI,this)}this.game.debugCollider&&(this.context.strokeStyle=this.game.debugColor,this.context.beginPath(),this.collisionSystem.draw(this.context),this.context.stroke()),this.context.translate(-this.camera.changes.x,-this.camera.changes.y);let i=this.width/2+this.camera.startCornerX,s=this.height/2+this.camera.startCornerY;this.context.translate(i,s),this.context.scale(this.camera.changes.zoom,this.camera.changes.zoom),this.context.translate(-i,-s),this.camera.changes.reset()}update(){this.tempScheduledCallbacks.length&&(this.scheduledCallbacks=this.scheduledCallbacks.concat(this.tempScheduledCallbacks),this.tempScheduledCallbacks=[]),this.scheduledCallbacks=this.scheduledCallbacks.filter(this.scheduledCallbackExecutor.execute(Date.now(),this.diffTime)),this.sprites.forEach((t,e)=>{for(let i of t){if(i.deleted){this.removeSprite(i,e);return}i.update(this.diffTime)}}),this.diffTime=0}run(){if(this._stopped){this._stopped=!1;for(let t of this.sprites.values())for(let e of t)e.run();this.pendingRun=!0,this.tryDoRun()}}ready(){this.tryDoOnReady(),this.tryDoRun();for(let t of this.sprites.values())for(let e of t)e.ready()}stop(){if(!this._stopped){this._running=!1,this._stopped=!0;for(let t of this.sprites.values())for(let e of t)e.stop();this.stoppedTime=Date.now()}}tryDoOnReady(){if(this.onReadyPending&&this.isReady()){if(this.onReadyPending=!1,this.backgrounds.length&&this.backgroundIndex===null&&this.switchBackground(0),this.onReadyCallbacks.length){for(let t of this.onReadyCallbacks)t();this.onReadyCallbacks=[]}this.game.eventEmitter.emit(D.STAGE_READY_EVENT,{stage:this})}}doOnStart(){for(let t of this.onStartCallbacks)setTimeout(()=>{t()})}tryDoRun(){this.pendingRun&&!this._running&&this.isReady()&&(this._running=!0,this.pendingRun=!1,this.doOnStart(),this.diffTime=Date.now()-this.stoppedTime,setTimeout(()=>{let t=this.stoppedTime,e=()=>{this._stopped||t!==this.stoppedTime||(this.render(),requestAnimationFrame(e))};e()}))}addListeners(){this.eventEmitter.on(D.SPRITE_READY_EVENT,D.SPRITE_READY_EVENT,t=>{this.id==t.detail.stageId&&(this.loadedSprites++,this.tryDoOnReady(),this.tryDoRun())})}};var ft=class{constructor(t,e,i,s){this.trackedKeys=[];this.receiveDataConnections=[];this.userKeydownCallbacks=new Map;this.systemLockedChars={};this.userLockedChars={};this.systemMouseLocked=!1;this.userMouseLocked=!1;this.game=e,this.connection=i,s&&this.defineListeners();let r=i.connect(g.RECEIVE_DATA,(n,a)=>{let l=JSON.parse(n),h=l.char;if(!(!a.SendTime||a.Keydown!="true"||a.MemberId!=t.id||!this.trackedKeys.includes(h))){if(this.userKeydownCallbacks.has(h)){let u=this.userKeydownCallbacks.get(h)[0],c=(_,f=[h],b=!1)=>{b&&(this.userMouseLocked=_);for(let v of f)this.userLockedChars[v.toUpperCase()]=_},m=0,p=()=>{if(this.userLockedChars[h]!==!0||m>999){let _=l.sync;_&&e.syncObjects(_,this.game.calcDeltaTime(a.SendTime)),u(t,c)}else m++,setTimeout(p,50)};p()}this.systemLockedChars[h]=!1}});this.receiveDataConnections.push(r);let o=i.connect(g.RECEIVE_DATA,(n,a)=>{if(!(!a.SendTime||a.Mousedown!="true"||a.MemberId!=t.id)){if(this.userMousedownCallback){let l=this.userMousedownCallback[0],h=JSON.parse(n),u=h.mouseX,c=h.mouseY,m=h.sync,p=(b,v=[],C=!0)=>{C&&(this.userMouseLocked=b);for(let S of v)this.userLockedChars[S.toUpperCase()]=b},_=0,f=()=>{if(this.userMouseLocked!==!0||_>999){m&&e.syncObjects(m,this.game.calcDeltaTime(a.SendTime));let b=new L(u,c);l(b,t,p)}else _++,setTimeout(f,50)};f()}this.systemMouseLocked=!1}});this.receiveDataConnections.push(o)}defineListeners(){this.keydownCallback=t=>{let e=P.getChar(t.keyCode);if(!this.userKeydownCallbacks.has(e)||this.systemLockedChars[e]===!0||this.userLockedChars[e]===!0||!this.trackedKeys.includes(e))return;this.systemLockedChars[e]=!0;let i=this.userKeydownCallbacks.get(e)[1],s=this.userKeydownCallbacks.get(e)[2],r=this.game.packSyncData(i,s);this.connection.sendData(JSON.stringify({char:e,sync:r}),{Keydown:"true"})},this.mousedownCallback=t=>{if(!this.userMousedownCallback||this.systemMouseLocked||this.userMouseLocked)return;let e=this.game.correctMouseX(t.clientX),i=this.game.correctMouseY(t.clientY);if(!this.game.isInsideGame(e,i))return;this.systemMouseLocked=!0;let s=this.userMousedownCallback[1],r=this.userMousedownCallback[2],o=this.game.packSyncData(s,r);this.connection.sendData(JSON.stringify({mouseX:e,mouseY:i,sync:o}),{Mousedown:"true"})},document.addEventListener("keydown",this.keydownCallback),document.addEventListener("mousedown",this.mousedownCallback)}stop(){this.keydownCallback&&document.removeEventListener("keydown",this.keydownCallback);for(let t of this.receiveDataConnections)this.connection.disconnect(g.RECEIVE_DATA,t)}keyDown(t,e,i,s=[]){t=t.toUpperCase(),this.trackedKeys.includes(t)||this.trackedKeys.push(t),this.userKeydownCallbacks.set(t,[e,i,s])}removeKeyDownHandler(t){t=t.toUpperCase(),this.userKeydownCallbacks.delete(t)}mouseDown(t,e,i=[]){this.userMousedownCallback=[t,e,i]}removeMouseDownHandler(){this.userMousedownCallback=null}};var G=class{constructor(t,e){this.parent=t,this.properties=e}getMultiplayerName(){return this.parent.getMultiplayerName()}getSyncId(){return this.parent.getSyncId()}increaseSyncId(){return this.parent.increaseSyncId()}getSyncData(){let t={};for(let e of this.properties)this.parent[e]&&(t[e]=this.parent[e]);return t}setSyncData(t,e,i){this.parent.setSyncData(t,e,i)}onSync(t){throw new Error("Not implemented.")}removeSyncHandler(){throw new Error("Not implemented.")}only(...t){throw new Error("Not implemented.")}};var gt=class{constructor(t,e,i){this.deleted=!1;this.id=t,this._isMe=e,this.game=i,this.multiplayerName="player_"+t,this.syncId=1,this.control=new ft(this,this.game,i.connection,e),this.reservedProps=Object.keys(this),this.reservedProps.push("reservedProps")}keyDown(t,e,i,s=[]){this.control.keyDown(t,e,i,s)}removeKeyDownHandler(t){this.control.removeKeyDownHandler(t)}mouseDown(t,e,i=[]){this.control.mouseDown(t,e,i)}removeMouseDownHandler(){this.control.removeMouseDownHandler()}isMe(){return this._isMe}delete(){if(this.deleted)return;this.control.stop();let t=Object.keys(this);for(let e=0;e<t.length;e++)delete this[t[e]];this.deleted=!0}repeat(t,e,i,s){if(this.deleted){s();return}if(t<1){s();return}let r=e(this);if(r===!1){s();return}if(r>0&&(i=r),t--,t<1){s();return}setTimeout(()=>{requestAnimationFrame(()=>this.repeat(t,e,i,s))},i)}forever(t,e=null){if(this.deleted)return;let i=t(this);i!==!1&&(i>0&&(e=i),e?setTimeout(()=>{requestAnimationFrame(()=>this.forever(t,e))},e):requestAnimationFrame(()=>this.forever(t)))}timeout(t,e){setTimeout(()=>{this.deleted||requestAnimationFrame(()=>t(this))},e)}getMultiplayerName(){return this.multiplayerName}getSyncId(){return this.syncId}increaseSyncId(){return this.syncId++,this.syncId}getSyncData(){let t={};for(let e of Object.keys(this))this.reservedProps.includes(e)||(t[e]=this[e]);return t}setSyncData(t,e,i){let s={};for(let r in e)e.hasOwnProperty(r)&&!this.reservedProps.includes(r)&&(s[r]=this[r],this[r]=e[r]);this.syncCallback&&this.syncCallback(this,t,e,s,i)}onSync(t){this.syncCallback=t}removeSyncHandler(){this.syncCallback=null}only(...t){return new G(this,t)}};var bt=class extends Q{constructor(t,e=null,i=1,s=[]){super(e,i,s),this.multiplayerName="sprite_"+t,this.syncId=1,this.reservedProps=Object.keys(this),this.reservedProps.push("body"),this.reservedProps.push("reservedProps")}generateUniqueId(){return Math.random().toString(36).slice(2)+"-"+Math.random().toString(36).slice(2)}getCustomerProperties(){let t={};for(let e of Object.keys(this))this.reservedProps.includes(e)||(t[e]=this[e]);return t}getMultiplayerName(){return this.multiplayerName}getSyncId(){return this.syncId}increaseSyncId(){return this.syncId++,this.syncId}getSyncData(){return Object.assign({},this.getCustomerProperties(),{size:this.size,rotateStyle:this.rotateStyle,costumeIndex:this.costumeIndex,deleted:this._deleted,x:this.x,y:this.y,direction:this.direction,hidden:this.hidden,stopped:this.stopped})}setSyncData(t,e,i){let s={};for(let r in e)e.hasOwnProperty(r)&&!this.reservedProps.includes(r)&&(s[r]=this[r],this[r]=e[r]);this.syncCallback&&this.syncCallback(this,t,e,s,i)}onSync(t){this.syncCallback=t}removeSyncHandler(){this.syncCallback=null}only(...t){return new G(this,t)}};var kt=class extends D{constructor(e,i,s,r,o=null,n=!0,a="ru",l=0,h=0,u={}){super(s,r,o,n,a);this.autoSyncGameTimeout=0;this.players=[];this.sharedObjects=[];this.autoSyncGameTimeout=h,this.initializeConnection(e,i,l,u)}send(e,i={},s,r=[]){if(!this.connection)throw new Error("Connection to the server is not established.");let o={data:e,sync:this.packSyncData(s,r)};this.connection.sendData(JSON.stringify(o),i)}sync(e,i=[],s={}){if(!i.length)return;s.SyncGame="true";let r=this.packSyncData(e,i);this.sendData(JSON.stringify(r),s)}syncGame(){let e=this.getSyncObjects(),i=this.packSyncData("game",e);this.sendData(JSON.stringify(i),{SyncGame:"true"})}onConnection(e){this.onConnectionCallback=e}removeConnectionHandler(e){this.onConnectionCallback=null}onReceive(e){this.onReceiveCallback=e}removeReceiveHandler(e){this.onReceiveCallback=null}onMemberJoined(e){this.onMemberJoinedCallback=e}removeMemberJoinedHandler(e){this.onMemberJoinedCallback=null}onMemberLeft(e){this.onMemberLeftCallback=e}removeMemberLeftHandler(e){this.onMemberLeftCallback=null}onGameStarted(e){this.onGameStartedCallback=e}removeGameStartedHandler(e){this.onGameStartedCallback=null}onGameStopped(e){this.onGameStoppedCallback=e}removeGameStoppedHandler(e){this.onGameStoppedCallback=null}onMultiplayerError(e){this.onMultiplayerErrorCallback=e}removeMultiplayerErrorHandler(e){this.onMultiplayerErrorCallback=null}run(){super.run(),this.isHost&&this.autoSyncGameTimeout&&this.autoSyncGame(this.autoSyncGameTimeout)}stop(){super.stop();for(let e of this.players)e.delete();this.players=[]}getPlayers(){return this.players}addSharedObject(e){this.sharedObjects.push(e)}removeSharedObject(e){let i=this.sharedObjects.indexOf(e);i>-1&&this.sharedObjects.splice(i,1)}getSharedObjects(){return this.sharedObjects}getMultiplayerSprites(){return this.getActiveStage()?this.getActiveStage().getSprites().filter(e=>e instanceof bt):[]}getSyncObjects(){let e=this.getMultiplayerSprites(),i=this.getPlayers(),s=this.getSharedObjects();return[...e,...i,...s]}syncObjects(e,i){let s=this.getSyncObjects();for(let[r,o]of Object.entries(e))for(let n of s)if(o[n.getMultiplayerName()]){let a=o[n.getMultiplayerName()];n.setSyncData(r,a,i)}}packSyncData(e,i){let s={};for(let o of i)s[o.getMultiplayerName()]=o.getSyncData(),s[o.getMultiplayerName()].syncId=o.increaseSyncId();let r={};return r[e]=s,r}sendData(e,i={}){if(!this.connection)throw new Error("Connection to the server is not established.");this.connection.sendData(e,i)}calcDeltaTime(e){return Date.now()-e-this.connection.deltaTime}extrapolate(e,i,s){let r=Math.round(i/s*.75);for(let o=0;o<r;o++)e()}async initializeConnection(e,i,s,r={}){let o=new g(e);try{this.connection=await o.connect(i,s,r),this.onConnectionCallback&&this.onConnectionCallback(this.connection),this.connection.connect(g.RECEIVE_DATA,(n,a,l)=>{if(!(!n||!this.running||!a.SendTime)){if(a.SyncGame==="true"){let h=JSON.parse(n);this.syncObjects(h,this.calcDeltaTime(a.SendTime))}else if(a.Keydown!=="true"&&a.Mousedown!=="true"&&this.onReceiveCallback){n=JSON.parse(n);let h=n.userData,u=n.sync;this.syncObjects(u,this.calcDeltaTime(a.SendTime)),this.onReceiveCallback(h,a,l)}}}),this.connection.connect(g.MEMBER_JOINED,(n,a)=>{this.onMemberJoinedCallback&&this.onMemberJoinedCallback(n,a)}),this.connection.connect(g.MEMBER_LEFT,(n,a)=>{this.onMemberLeftCallback&&this.onMemberLeftCallback(n,a)}),this.connection.connect(g.GAME_STARTED,n=>{let a=n.HostId,l=n.Members?.split(",")??[];this.players=l.map(h=>new gt(h,h===this.connection.memberId,this)),this.isHost=a===this.connection.memberId,this.onGameStartedCallback&&this.onGameStartedCallback(this.players,n)}),this.connection.connect(g.GAME_STOPPED,n=>{this.onGameStoppedCallback&&this.onGameStoppedCallback(n)}),this.connection.connect(g.ERROR,n=>{this.onMultiplayerError&&this.onMultiplayerError(n)})}catch(n){console.error(n)}}autoSyncGame(e){setInterval(()=>{this.syncGame()},e)}};var Tt=class{constructor(t){if(this.multiplayerName="data_"+t,this.syncId=1,!k.getInstance().has("game"))throw new Error("You need create Game instance before Sprite instance.");k.getInstance().get("game").addSharedObject(this)}generateUniqueId(){return Math.random().toString(36).slice(2)+"-"+Math.random().toString(36).slice(2)}getMultiplayerName(){return this.multiplayerName}getSyncId(){return this.syncId}increaseSyncId(){return this.syncId++,this.syncId}getSyncData(){let t={};for(let e of Object.keys(this))t[e]=this[e];return t}setSyncData(t,e,i){let s={};for(let r in e)e.hasOwnProperty(r)&&(s[r]=this[r],this[r]=e[r]);this.syncCallback&&this.syncCallback(this,t,e,s,i)}onSync(t){this.syncCallback=t}removeSyncHandler(){this.syncCallback=null}only(...t){return new G(this,t)}};export{at as BVH,it as BVHBranch,pt as Camera,_t as CameraChanges,Y as CircleCollider,q as Collider,M as CollisionResult,ht as CollisionSystem,W as Costume,y as ErrorMessages,H as EventEmitter,D as Game,g as JetcodeSocket,ot as JetcodeSocketConnection,dt as Keyboard,P as KeyboardMap,ut as Mouse,ft as MultiplayerControl,kt as MultiplayerGame,bt as MultiplayerSprite,G as OrphanSharedData,gt as Player,L as PointCollider,w as PolygonCollider,k as Registry,lt as SAT,Z as ScheduledCallbackExecutor,X as ScheduledCallbackItem,B as ScheduledState,Tt as SharedData,Q as Sprite,Ot as Stage,st as Styles,mt as ValidatorFactory,Rt as aabbAABB,Dt as circleCircle,Et as polygonCircle,Mt as polygonPolygon,wt as separatingAxis};
//# sourceMappingURL=scrub.mjs.map